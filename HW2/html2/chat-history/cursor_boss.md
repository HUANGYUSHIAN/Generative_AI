# è¨­è¨ˆbossæˆ°é¬¥å­ç¶²é åŠŸèƒ½
_Exported on 2025/9/27 at 22:25:00 [GMT+8] from Cursor (1.6.42)_

---

**User**

è«‹å¹«æˆ‘ä¾ç…§ä»¥ä¸‹æ¼”åŒ´æ³•å®Œæˆbossæˆ°é¬¥çš„å­ç¶²é 
1. åˆ‡æ›bossæˆ°é¬¥çš„å­é é¢æ™‚ï¼Œç•«é¢æœ‰ä¸€å€‹é–‹å§‹æˆ°é¬¥çš„æŒ‰éˆ•ï¼Œå³ä¸Šæ–¹æœ‰å€‹è¿”å›ä¸»é é¢çš„æŒ‰éˆ•ã€‚ä¸€æ—¦æŒ‰ä¸‹é–‹å§‹æˆ°é¬¥çš„æŒ‰éˆ•ä¹‹å¾Œï¼Œç›´åˆ°æˆ°é¬¥çµæŸå‰ï¼Œè¿”å›æˆ°é¬¥çš„æŒ‰éˆ•æœƒè¢«disabled
2. æˆ°é¬¥æ¯æ¬¡20å€‹å›åˆï¼Œæ¯å›åˆçš„ç§’æ•¸ç‚ºdata.jsä¸­çš„æ”»æ“ŠåŠ›ä½œç‚ºç§’æ•¸ï¼Œåœ¨ç•«é¢çš„å·¦ä¸Šæ–¹æœ‰å€’æ•¸çš„é¦¬éŒ¶é¡¯ç¤ºå€’æ•¸ä¸­çš„ç§’æ•¸
3. æ¯å›åˆçš„æˆ°é¬¥ç‚ºåœ¨4å€‹é¸é …ä¸­é¸å‡ºä¸€å€‹æ­£ç¢ºçš„ç­”æ¡ˆï¼Œä¸€æ—¦ç©å®¶ç­”éŒ¯æˆ–æ˜¯æœªèƒ½åœ¨è¦å®šçš„æ™‚é–“å…§å›ç­”ï¼Œå‰‡ç©å®¶ç”Ÿå‘½å€¼æ‰£2é»ï¼›è‹¥ç©å®¶å›ç­”æ­£ç¢ºï¼Œå‰‡ç©å®¶å‰©é¤˜å›ç­”æ™‚é–“+é˜²ç¦¦ç‡-13ï¼Œæ¨å»å°æ•¸é»å¾Œä½œç‚ºè©²é¡Œçš„å¾—åˆ†ã€‚æ­¤å¤–ï¼Œæ ¹æ“šç­”é¡Œæ˜¯å¦æ­£ç¢ºï¼Œç•«é¢æœƒé¡¯ç¤ºç‰¹æ•ˆï¼Œè¢«æ‰£ç”Ÿå‘½å€¼æ™‚æœƒå†’ç«æŸ±ä¸¦ç•«é¢æµè¡€ï¼›å›ç­”æ­£ç¢ºå‰‡æ˜¯æœ‰é‡‘å¹£è½åœ°çš„éŸ³æ•ˆï¼Œä¸¦é¡¯ç¤ºå¾—åˆ†ã€‚æ­¤ç‰¹æ•ˆ0.5ç§’ä¸”ä¸å½±éŸ¿éŠæˆ²æœ¬èº«çš„è¨ˆæ™‚
4. å¦‚æœç”Ÿå‘½å€¼æ­¸<=0å‰‡éŠæˆ²åœæ­¢ï¼Œå¾—åˆ†æ­¸0ä¸¦é¡¯ç¤ºæŒ‘æˆ°å¤±æ•—ï¼Œä¸¦é¡¯ç¤ºæŒ‘æˆ°å¤±æ•—ç©å®¶æ­»äº¡çš„ç•«é¢ï¼›åä¹‹å‰‡å‘ˆç¾ç©å®¶æŒ‘æˆ°æˆåŠŸçš„ç•«é¢ï¼Œä¸¦å°‡ç¸½å¾—åˆ†ä½œç‚ºéŠæˆ²é»æ•¸ï¼Œå³æ™‚æ›´æ–°ä¸¦å„²å­˜ï¼Œç•«é¢é¡¯ç¤ºç©å®¶æˆ°å‹bossèˆ‡å¾—åˆ†
5. éŠæˆ²èµ·å§‹æ™‚åˆ©ç”¨priority queueä¾ç…§priorityç”±å°åˆ°å¤§å­˜æ”¾å–®å­—ï¼ŒåŒæ¨£priorityå‰‡äº‚æ•¸æ’åˆ—ã€‚æ¸¬é©—æ¨¡å¼åˆ†æˆ3ç¨®ï¼Œæ¯ç¨®æ¨¡å¼éš¨æ©Ÿé¸æ“‡ï¼š(1)çµ¦sentenceé¸å°æ‡‰çš„meaning (2) çµ¦meaningé¸å°æ‡‰çš„sentence (3)çµ¦sentenceæŠŠ<å–®å­—<å…§çš„æŒ–ç©ºï¼Œ<å–®å­—<(å»é™¤<çš„ç¬¦è™Ÿ)åšç‚ºé¸é …ã€‚ç„¡è«–ä½•ç¨®æ¨¡å¼ï¼Œå…ˆå°‡æ­£ç¢ºçš„ç­”æ¡ˆéš¨æ©Ÿè¨­å®šåœ¨å››å€‹é¸é …ä¸­çš„éš¨æ©Ÿä¸€å€‹ä½ç½®ï¼Œå…¶ä»–ä½ç½®å‰‡å¾å–®å­—æœ¬ä¸­(åŒ…å«å°šæœªè§£é–çš„)ï¼Œéš¨æ©Ÿé¸å–ä¸é‡è¤‡è€…å¡«å…¥ï¼Œç‚ºäº†é¿å…é‡åˆ°ä¸€å­—å¤šç¾©ï¼Œè«‹æª¢å¯Ÿspellingæ˜¯å¦ä¸€æ¨£ï¼Œä¸€æ¨£æ™‚è«‹å¾æ–°é¸å–
6. åœ¨bossæˆ°ä¸­å›ç­”æ­£ç¢ºè€…è©²å–®å­—priority += 1ï¼Œç­”éŒ¯æˆ–è¶…æ™‚å‰‡priorityæ”¹ç‚º1ï¼Œä¸¦åœ¨çµæŸæ™‚åšç´€éŒ„ä»¥ä¾¿å³æ™‚æ›´æ–°                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         

---

**Cursor**

æˆ‘éœ€è¦å…ˆäº†è§£ç¾æœ‰çš„ä»£ç¢¼çµæ§‹å’Œæ•¸æ“šæ ¼å¼ï¼Œç„¶å¾Œå‰µå»º boss æˆ°é¬¥çš„å­ç¶²é ã€‚è®“æˆ‘å…ˆæª¢æŸ¥ç›¸é—œæ–‡ä»¶çš„å…§å®¹ã€‚

ç¾åœ¨æˆ‘ä¾†æª¢æŸ¥é …ç›®çš„çµæ§‹ä¸¦äº†è§£æ˜¯å¦å·²æœ‰HTMLæ–‡ä»¶ï¼š

è®“æˆ‘æŸ¥çœ‹ç¾æœ‰çš„HTMLå’ŒCSSæª”æ¡ˆä»¥äº†è§£ç¾æœ‰çš„é é¢çµæ§‹ï¼š

ç¾åœ¨æˆ‘äº†è§£äº†é …ç›®çµæ§‹ã€‚æˆ‘éœ€è¦æ ¹æ“šè¦æ±‚å¯¦ç¾ Boss æˆ°é¬¥ç³»çµ±ã€‚è®“æˆ‘å‰µå»ºä»»å‹™æ¸…å–®ä¸¦é–‹å§‹å¯¦ç¾ï¼š

è®“æˆ‘å…ˆæ›¿æ› Boss æˆ°é¬¥é é¢çš„ HTML çµæ§‹ï¼š

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æ–‡å–®å­—èƒŒèª¦éŠæˆ²</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="words_data.js"></script>
    <script src="data.js"></script>
</head>
<body>
    <div id="app">
        <!-- ä¸»é é¢ -->
        <div id="main-page" class="page active">
            <div class="container">
                <h1>æ—¥æ–‡å–®å­—èƒŒèª¦éŠæˆ²</h1>
                <div class="menu-buttons">
                    <button class="menu-btn" onclick="showPage('review-page')">
                        <span class="btn-icon">ğŸ“š</span>
                        å–®å­—è¤‡ç¿’
                    </button>
                    <button class="menu-btn" onclick="showPage('boss-page')">
                        <span class="btn-icon">âš”ï¸</span>
                        Bossæˆ°é¬¥
                    </button>
                    <button class="menu-btn" onclick="showPage('shop-page')">
                        <span class="btn-icon">ğŸ›’</span>
                        å‡ç´šå•†åº—
                    </button>
                </div>
                <div class="status-info">
                    <div class="loading-status" id="main-loading-status">æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...</div>
                </div>
            </div>
        </div>

        <!-- å–®å­—è¤‡ç¿’é é¢ -->
        <div id="review-page" class="page">
            <div class="container">
                <button class="back-btn" onclick="showPage('main-page')">â† å›åˆ°ä¸»é é¢</button>
                
                <div class="word-card" id="word-card">
                    <div class="loading" id="loading-message">è«‹å…ˆä¸Šå‚³å–®å­—æª”æ¡ˆ</div>
                    <div class="word-content" id="word-content" style="display: none;">
                        <div class="word-info">
                            <div class="word-counter">
                                <span id="current-word-index">1</span> / <span id="total-words">0</span>
                            </div>
                        </div>
                        
                        <div class="word-display">
                            <div class="word-main">
                                <h2 class="word" id="word-text">å–®å­—</h2>
                                <p class="spelling" id="spelling-text">æ‹¼éŸ³</p>
                            </div>
                            
                            <div class="meaning">
                                <h3>ä¸­æ–‡æ„æ€</h3>
                                <p id="meaning-text">æ„æ€</p>
                            </div>
                            
                            <div class="sentence">
                                <h3>ä¾‹å¥</h3>
                                <p id="sentence-text">ä¾‹å¥</p>
                            </div>
                        </div>
                        
                        <div class="controls">
                            <button class="control-btn prev-btn" onclick="previousWord()">
                                â† Previous
                            </button>
                            <button class="control-btn sound-btn" onclick="playSound()">
                                ğŸ”Š Sound
                            </button>
                            <button class="control-btn next-btn" onclick="nextWord()">
                                Next â†’
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bossæˆ°é¬¥é é¢ -->
        <div id="boss-page" class="page">
            <div class="container boss-container">
                <button class="back-btn" id="boss-back-btn" onclick="returnToMain()">â† å›åˆ°ä¸»é é¢</button>
                
                <!-- æˆ°é¬¥ç‹€æ…‹é¡¯ç¤º -->
                <div class="boss-status-bar">
                    <div class="boss-timer">
                        <span class="timer-label">å‰©é¤˜æ™‚é–“:</span>
                        <span class="timer-display" id="boss-timer">0</span>
                        <span class="timer-unit">ç§’</span>
                    </div>
                    <div class="boss-health">
                        <span class="health-label">ç”Ÿå‘½å€¼:</span>
                        <span class="health-display" id="boss-health">10</span>
                    </div>
                    <div class="boss-round">
                        <span class="round-label">å›åˆ:</span>
                        <span class="round-display" id="boss-round">1/20</span>
                    </div>
                </div>

                <!-- æˆ°é¬¥ä¸»è¦å€åŸŸ -->
                <div class="boss-battle-area" id="boss-battle-area">
                    <!-- é–‹å§‹ç•«é¢ -->
                    <div class="boss-start-screen" id="boss-start-screen">
                        <div class="boss-intro">
                            <h2>âš”ï¸ Boss æˆ°é¬¥æŒ‘æˆ° âš”ï¸</h2>
                            <div class="boss-rules">
                                <h3>æˆ°é¬¥è¦å‰‡ï¼š</h3>
                                <ul>
                                    <li>ğŸ¯ ç¸½å…± 20 å€‹å›åˆ</li>
                                    <li>â±ï¸ æ¯å›åˆæ™‚é–“é™åˆ¶ç‚ºä½ çš„æ”»æ“ŠåŠ›ç§’æ•¸</li>
                                    <li>ğŸ’” ç­”éŒ¯æˆ–è¶…æ™‚æ‰£ 2 é»ç”Ÿå‘½å€¼</li>
                                    <li>ğŸ’° ç­”å°å¾—åˆ† = å‰©é¤˜æ™‚é–“ + é˜²ç¦¦å€¼ - 13</li>
                                    <li>â¤ï¸ ç”Ÿå‘½å€¼æ­¸é›¶å³æŒ‘æˆ°å¤±æ•—</li>
                                </ul>
                            </div>
                            <button class="boss-start-btn" id="boss-start-btn" onclick="startBossBattle()">
                                ğŸ”¥ é–‹å§‹æˆ°é¬¥ ğŸ”¥
                            </button>
                        </div>
                    </div>

                    <!-- æˆ°é¬¥é€²è¡Œä¸­ç•«é¢ -->
                    <div class="boss-game-screen" id="boss-game-screen" style="display: none;">
                        <div class="question-area">
                            <div class="question-type" id="question-type">é¡Œå‹ï¼šä¸­è­¯æ—¥</div>
                            <div class="question-content" id="question-content">
                                <h3 id="question-title">è«‹é¸æ“‡æ­£ç¢ºç­”æ¡ˆï¼š</h3>
                                <p class="question-text" id="question-text">å•é¡Œå…§å®¹</p>
                            </div>
                        </div>

                        <div class="answer-options" id="answer-options">
                            <button class="answer-btn" onclick="selectAnswer(0)">é¸é …A</button>
                            <button class="answer-btn" onclick="selectAnswer(1)">é¸é …B</button>
                            <button class="answer-btn" onclick="selectAnswer(2)">é¸é …C</button>
                            <button class="answer-btn" onclick="selectAnswer(3)">é¸é …D</button>
                        </div>

                        <div class="boss-score">
                            <span class="score-label">ç•¶å‰å¾—åˆ†:</span>
                            <span class="score-display" id="boss-score">0</span>
                        </div>
                    </div>

                    <!-- æˆ°é¬¥çµæŸç•«é¢ -->
                    <div class="boss-end-screen" id="boss-end-screen" style="display: none;">
                        <div class="end-result" id="end-result">
                            <!-- çµæœå…§å®¹æœƒå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                        <button class="boss-restart-btn" onclick="showBossStartScreen()">å†æ¬¡æŒ‘æˆ°</button>
                        <button class="boss-main-btn" onclick="showPage('main-page')">å›åˆ°ä¸»é é¢</button>
                    </div>
                </div>

                <!-- ç‰¹æ•ˆå€åŸŸ -->
                <div class="boss-effects" id="boss-effects">
                    <!-- ç‰¹æ•ˆæœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- å‡ç´šå•†åº—é é¢ -->
        <div id="shop-page" class="page">
            <div class="container">
                <button class="back-btn" onclick="showPage('main-page')">â† å›åˆ°ä¸»é é¢</button>
                
                <div class="shop-content">
                    <h2 class="shop-title">ğŸ›’ å‡ç´šå•†åº—</h2>
                    
                    <!-- ç©å®¶ç‹€æ…‹é¡¯ç¤º -->
                    <div class="player-stats">
                        <h3>ç©å®¶ç‹€æ…‹</h3>
                        <div class="stats-grid">
                            <div class="stat-item points">
                                <span class="stat-icon">ğŸ’°</span>
                                <span class="stat-label">éŠæˆ²é»æ•¸</span>
                                <span class="stat-value" id="player-points">0</span>
                            </div>
                            <div class="stat-item health">
                                <span class="stat-icon">â¤ï¸</span>
                                <span class="stat-label">ç”Ÿå‘½å€¼</span>
                                <span class="stat-value" id="player-health">5/10</span>
                            </div>
                            <div class="stat-item defense">
                                <span class="stat-icon">ğŸ›¡ï¸</span>
                                <span class="stat-label">é˜²ç¦¦å€¼</span>
                                <span class="stat-value" id="player-defense">5/10</span>
                            </div>
                            <div class="stat-item attack">
                                <span class="stat-icon">âš”ï¸</span>
                                <span class="stat-label">æ”»æ“ŠåŠ›</span>
                                <span class="stat-value" id="player-attack">10/15</span>
                            </div>
                            <div class="stat-item free-unlocks">
                                <span class="stat-icon">ğŸ</span>
                                <span class="stat-label">å…è²»è§£é–</span>
                                <span class="stat-value" id="player-free-unlocks">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- å•†åº—åŠŸèƒ½å€ -->
                    <div class="shop-sections">
                        <!-- é‚„åŸéŠæˆ² -->
                        <div class="shop-section">
                            <h3>ğŸ”„ éŠæˆ²ç®¡ç†</h3>
                            <div class="shop-item reset">
                                <div class="item-info">
                                    <h4>é‚„åŸéŠæˆ²</h4>
                                    <p>é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Œéš¨æ©Ÿé¸å–20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²</p>
                                </div>
                                <button class="shop-btn reset-btn" onclick="resetGame()">
                                    å…è²»é‡ç½®
                                </button>
                            </div>
                        </div>

                        <!-- è§’è‰²å‡ç´š -->
                        <div class="shop-section">
                            <h3>â¬†ï¸ è§’è‰²å‡ç´š (10é»/æ¬¡)</h3>
                            <div class="upgrade-grid">
                                <div class="shop-item upgrade">
                                    <div class="item-info">
                                        <h4>â¤ï¸ ç”Ÿå‘½å€¼ +1</h4>
                                        <p>å¢åŠ ç”Ÿå‘½å€¼ä¸Šé™</p>
                                    </div>
                                    <button class="shop-btn upgrade-btn" onclick="upgradeHealth()">
                                        10é»
                                    </button>
                                </div>
                                <div class="shop-item upgrade">
                                    <div class="item-info">
                                        <h4>ğŸ›¡ï¸ é˜²ç¦¦å€¼ +1</h4>
                                        <p>å¢åŠ é˜²ç¦¦åŠ›</p>
                                    </div>
                                    <button class="shop-btn upgrade-btn" onclick="upgradeDefense()">
                                        10é»
                                    </button>
                                </div>
                                <div class="shop-item upgrade">
                                    <div class="item-info">
                                        <h4>âš”ï¸ æ”»æ“ŠåŠ› +1</h4>
                                        <p>å¢åŠ æ”»æ“Šå‚·å®³</p>
                                    </div>
                                    <button class="shop-btn upgrade-btn" onclick="upgradeAttack()">
                                        10é»
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- è§£é–å–®å­— -->
                        <div class="shop-section">
                            <h3>ğŸ“š è§£é–å–®å­—</h3>
                            <div class="shop-item unlock">
                                <div class="item-info">
                                    <h4>è§£é–æ–°å–®å­— (10å€‹)</h4>
                                    <p>éš¨æ©Ÿè§£é–10å€‹æ–°çš„æ—¥æ–‡å–®å­—é€²è¡Œå­¸ç¿’</p>
                                    <p class="unlock-info">å¯è§£é–å–®å­—æ•¸é‡: <span id="unlockable-count">0</span></p>
                                </div>
                                <div class="unlock-buttons">
                                    <button class="shop-btn unlock-btn" onclick="unlockWord()">
                                        20é»
                                    </button>
                                    <button class="shop-btn free-unlock-btn" onclick="freeUnlockWord()" id="free-unlock-btn">
                                        å…è²»è§£é–
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
                    <div class="shop-message" id="shop-message"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>

```

ç¾åœ¨æˆ‘éœ€è¦æ›´æ–° todo ç‹€æ…‹ä¸¦æ·»åŠ  CSS æ¨£å¼ï¼š

```css
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* é é¢åˆ‡æ› */
.page {
    display: none;
    width: 100%;
}

.page.active {
    display: block;
}

/* ä¸»é é¢æ¨£å¼ */
#main-page h1 {
    text-align: center;
    font-size: 2.5rem;
    color: white;
    margin-bottom: 2rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
    width: 100%;
    max-width: 400px;
}

.menu-btn {
    background: white;
    border: none;
    padding: 1.5rem 2rem;
    border-radius: 15px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.menu-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    background: #f7fafc;
}

.btn-icon {
    font-size: 1.5rem;
}

/* ç‹€æ…‹è³‡è¨Š */
.status-info {
    width: 100%;
    max-width: 400px;
}

.loading-status {
    background: rgba(255,255,255,0.9);
    color: #4a5568;
    padding: 1rem 2rem;
    border-radius: 10px;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.loading-status.success {
    background: #48bb78;
    color: white;
}

.loading-status.error {
    background: #e53e3e;
    color: white;
}

/* è¿”å›æŒ‰éˆ• */
.back-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.9);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    color: #4a5568;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.back-btn:hover {
    background: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* å–®å­—å¡ç‰‡ */
.word-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 600px;
    margin-top: 2rem;
}

.loading {
    text-align: center;
    font-size: 1.2rem;
    color: #666;
    padding: 2rem;
}

.word-info {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1rem;
}

.word-counter {
    background: #e2e8f0;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    color: #4a5568;
    font-weight: bold;
}

.word-display {
    text-align: center;
    margin-bottom: 2rem;
}

.word-main {
    margin-bottom: 2rem;
}

.word {
    font-size: 3rem;
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.spelling {
    font-size: 1.5rem;
    color: #718096;
    font-style: italic;
}

.meaning, .sentence {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f7fafc;
    border-radius: 10px;
    text-align: left;
}

.meaning h3, .sentence h3 {
    color: #4a5568;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.meaning p, .sentence p {
    color: #2d3748;
    font-size: 1.1rem;
    line-height: 1.6;
}

/* æ§åˆ¶æŒ‰éˆ• */
.controls {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.control-btn {
    flex: 1;
    padding: 1rem;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.prev-btn {
    background: #cbd5e0;
    color: #4a5568;
}

.prev-btn:hover {
    background: #a0aec0;
    transform: translateY(-1px);
}

.sound-btn {
    background: #48bb78;
    color: white;
}

.sound-btn:hover {
    background: #38a169;
    transform: translateY(-1px);
}

.next-btn {
    background: #4299e1;
    color: white;
}

.next-btn:hover {
    background: #3182ce;
    transform: translateY(-1px);
}

.control-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.control-btn:disabled:hover {
    transform: none;
}

/* ä½”ä½é é¢ */
.placeholder {
    text-align: center;
    color: white;
    padding: 4rem 2rem;
}

.placeholder h2 {
    font-size: 2rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.placeholder p {
    font-size: 1.2rem;
    opacity: 0.9;
}

/* å•†åº—é é¢æ¨£å¼ */
.shop-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 900px;
    margin-top: 2rem;
}

.shop-title {
    text-align: center;
    color: #2d3748;
    margin-bottom: 2rem;
    font-size: 2rem;
}

/* ç©å®¶ç‹€æ…‹å€ */
.player-stats {
    background: #f7fafc;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.player-stats h3 {
    color: #4a5568;
    margin-bottom: 1rem;
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
}

.stat-icon {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 0.5rem;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #718096;
    margin-bottom: 0.25rem;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: bold;
    color: #2d3748;
}

.stat-item.points .stat-value {
    color: #d69e2e;
}

.stat-item.health .stat-value {
    color: #e53e3e;
}

.stat-item.defense .stat-value {
    color: #3182ce;
}

.stat-item.attack .stat-value {
    color: #38a169;
}

.stat-item.free-unlocks .stat-value {
    color: #9f7aea;
}

/* å•†åº—å€å¡Š */
.shop-sections {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.shop-section {
    border: 2px solid #e2e8f0;
    border-radius: 15px;
    padding: 1.5rem;
    background: #fafafa;
}

.shop-section h3 {
    color: #4a5568;
    margin-bottom: 1rem;
    font-size: 1.3rem;
}

.shop-item {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}

.shop-item:last-child {
    margin-bottom: 0;
}

.shop-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.item-info {
    flex: 1;
}

.item-info h4 {
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.item-info p {
    color: #718096;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.unlock-info {
    font-weight: bold;
    color: #4a5568 !important;
}

/* å‡ç´šç¶²æ ¼ */
.upgrade-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
}

.upgrade-grid .shop-item {
    margin-bottom: 0;
}

/* å•†åº—æŒ‰éˆ• */
.shop-btn {
    background: #4299e1;
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    min-width: 80px;
}

.shop-btn:hover {
    background: #3182ce;
    transform: translateY(-1px);
}

.shop-btn:disabled {
    background: #cbd5e0;
    color: #a0aec0;
    cursor: not-allowed;
}

.shop-btn:disabled:hover {
    transform: none;
}

.reset-btn {
    background: #48bb78;
}

.reset-btn:hover {
    background: #38a169;
}

.upgrade-btn {
    background: #ed8936;
}

.upgrade-btn:hover {
    background: #dd6b20;
}

.unlock-btn {
    background: #9f7aea;
}

.unlock-btn:hover {
    background: #805ad5;
}

.free-unlock-btn {
    background: #48bb78;
    margin-left: 0.5rem;
}

.free-unlock-btn:hover {
    background: #38a169;
}

.unlock-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* è¨Šæ¯é¡¯ç¤º */
.shop-message {
    text-align: center;
    padding: 1rem;
    margin-top: 1rem;
    border-radius: 8px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.shop-message.success {
    background: #c6f6d5;
    color: #22543d;
    border: 1px solid #9ae6b4;
}

.shop-message.error {
    background: #fed7d7;
    color: #742a2a;
    border: 1px solid #fc8181;
}

.shop-message.info {
    background: #bee3f8;
    color: #2a4365;
    border: 1px solid #90cdf4;
}

/* ==========================================
   Bossæˆ°é¬¥é é¢æ¨£å¼
   ========================================== */

/* Bosså®¹å™¨ */
.boss-container {
    position: relative;
    max-width: 1000px;
    padding: 20px;
}

/* ç‹€æ…‹æ¬„ */
.boss-status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 15px 25px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
    z-index: 100;
}

.boss-timer, .boss-health, .boss-round {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
}

.timer-label, .health-label, .round-label {
    color: #4a5568;
    font-size: 0.9rem;
}

.timer-display {
    color: #e53e3e;
    font-size: 1.5rem;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

.timer-unit {
    color: #718096;
    font-size: 0.9rem;
}

.health-display {
    color: #e53e3e;
    font-size: 1.2rem;
}

.round-display {
    color: #4299e1;
    font-size: 1.2rem;
}

/* æˆ°é¬¥å€åŸŸ */
.boss-battle-area {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    min-height: 500px;
    position: relative;
}

/* é–‹å§‹ç•«é¢ */
.boss-start-screen {
    text-align: center;
    padding: 2rem;
}

.boss-intro h2 {
    color: #2d3748;
    margin-bottom: 2rem;
    font-size: 2.5rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.boss-rules {
    background: #f7fafc;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: left;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.boss-rules h3 {
    color: #4a5568;
    margin-bottom: 1rem;
    text-align: center;
}

.boss-rules ul {
    list-style: none;
    padding: 0;
}

.boss-rules li {
    background: white;
    margin-bottom: 0.5rem;
    padding: 0.8rem;
    border-radius: 8px;
    color: #2d3748;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.boss-start-btn {
    background: linear-gradient(135deg, #e53e3e, #c53030);
    color: white;
    border: none;
    padding: 1.5rem 3rem;
    border-radius: 15px;
    font-size: 1.3rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.boss-start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(229, 62, 62, 0.4);
}

.boss-start-btn:active {
    transform: translateY(0);
}

/* éŠæˆ²ç•«é¢ */
.boss-game-screen {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    height: 100%;
}

.question-area {
    text-align: center;
    margin-bottom: 1rem;
}

.question-type {
    background: #4299e1;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 1rem;
}

.question-content {
    background: #f7fafc;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.question-content h3 {
    color: #4a5568;
    margin-bottom: 1rem;
}

.question-text {
    color: #2d3748;
    font-size: 1.2rem;
    font-weight: bold;
    line-height: 1.6;
}

/* ç­”æ¡ˆé¸é … */
.answer-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

.answer-btn {
    background: white;
    border: 2px solid #e2e8f0;
    padding: 1.5rem 1rem;
    border-radius: 12px;
    font-size: 1rem;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.4;
}

.answer-btn:hover {
    border-color: #4299e1;
    background: #ebf8ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
}

.answer-btn:active {
    transform: translateY(0);
}

.answer-btn.correct {
    background: #c6f6d5;
    border-color: #38a169;
    color: #22543d;
}

.answer-btn.wrong {
    background: #fed7d7;
    border-color: #e53e3e;
    color: #742a2a;
}

.answer-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.answer-btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* å¾—åˆ†é¡¯ç¤º */
.boss-score {
    text-align: center;
    background: #ffd700;
    padding: 1rem;
    border-radius: 10px;
    font-weight: bold;
    font-size: 1.2rem;
    color: #744210;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

/* çµæŸç•«é¢ */
.boss-end-screen {
    text-align: center;
    padding: 2rem;
}

.end-result {
    margin-bottom: 2rem;
}

.victory-screen {
    color: #22543d;
}

.victory-screen h2 {
    color: #38a169;
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.defeat-screen {
    color: #742a2a;
}

.defeat-screen h2 {
    color: #e53e3e;
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.final-score {
    background: #ffd700;
    padding: 1rem 2rem;
    border-radius: 15px;
    margin: 1rem 0;
    font-size: 1.5rem;
    font-weight: bold;
    color: #744210;
}

.boss-restart-btn, .boss-main-btn {
    background: #4299e1;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    margin: 0.5rem;
    transition: all 0.3s ease;
}

.boss-restart-btn:hover, .boss-main-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
}

.boss-restart-btn {
    background: #38a169;
}

.boss-restart-btn:hover {
    box-shadow: 0 4px 15px rgba(56, 161, 105, 0.3);
}

/* ç‰¹æ•ˆå€åŸŸ */
.boss-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
}

/* ç«æŸ±ç‰¹æ•ˆ */
.fire-effect {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 200px;
    background: linear-gradient(to top, #ff4500, #ff6347, #ffa500, transparent);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    animation: fireFlicker 0.5s ease-in-out;
    opacity: 0.8;
}

@keyframes fireFlicker {
    0%, 100% {
        transform: translateX(-50%) scale(1);
        opacity: 0.8;
    }
    50% {
        transform: translateX(-50%) scale(1.2);
        opacity: 1;
    }
}

/* æµè¡€ç‰¹æ•ˆ */
.blood-effect {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, transparent, rgba(255, 0, 0, 0.3));
    animation: bloodPulse 0.5s ease-in-out;
}

@keyframes bloodPulse {
    0%, 100% {
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
}

/* é‡‘å¹£ç‰¹æ•ˆ */
.coin-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    color: #ffd700;
    animation: coinDrop 0.5s ease-out;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

@keyframes coinDrop {
    0% {
        transform: translate(-50%, -150%) scale(0);
        opacity: 0;
    }
    50% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
    }
    100% {
        transform: translate(-50%, 50%) scale(1);
        opacity: 0;
    }
}

/* å¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ */
.score-popup {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #ffd700;
    color: #744210;
    padding: 1rem 2rem;
    border-radius: 15px;
    font-size: 1.5rem;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
    animation: scorePopup 0.5s ease-out;
}

@keyframes scorePopup {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
    50% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    #main-page h1 {
        font-size: 2rem;
    }
    
    .word {
        font-size: 2.5rem;
    }
    
    .controls {
        flex-direction: column;
    }
    
    .back-btn {
        position: relative;
        top: 0;
        right: 0;
        margin-bottom: 1rem;
        align-self: flex-end;
    }
    
    /* å•†åº—éŸ¿æ‡‰å¼ */
    .shop-content {
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .shop-title {
        font-size: 1.5rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
    
    .upgrade-grid {
        grid-template-columns: 1fr;
    }
    
    .shop-item {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .shop-item .shop-btn {
        width: 100%;
    }
    
    .unlock-buttons {
        justify-content: center;
    }
    
    .unlock-buttons .shop-btn {
        flex: 1;
        max-width: 120px;
    }
}

```

ç¾åœ¨æˆ‘éœ€è¦æ·»åŠ éŸ¿æ‡‰å¼è¨­è¨ˆçš„æ¨£å¼ï¼Œä¸¦ä¸”ç¹¼çºŒå¯¦ç¾ Boss æˆ°é¬¥é‚è¼¯ï¼š

```css
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

/* é é¢åˆ‡æ› */
.page {
    display: none;
    width: 100%;
}

.page.active {
    display: block;
}

/* ä¸»é é¢æ¨£å¼ */
#main-page h1 {
    text-align: center;
    font-size: 2.5rem;
    color: white;
    margin-bottom: 2rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.menu-buttons {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
    width: 100%;
    max-width: 400px;
}

.menu-btn {
    background: white;
    border: none;
    padding: 1.5rem 2rem;
    border-radius: 15px;
    font-size: 1.2rem;
    font-weight: bold;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.menu-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    background: #f7fafc;
}

.btn-icon {
    font-size: 1.5rem;
}

/* ç‹€æ…‹è³‡è¨Š */
.status-info {
    width: 100%;
    max-width: 400px;
}

.loading-status {
    background: rgba(255,255,255,0.9);
    color: #4a5568;
    padding: 1rem 2rem;
    border-radius: 10px;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.loading-status.success {
    background: #48bb78;
    color: white;
}

.loading-status.error {
    background: #e53e3e;
    color: white;
}

/* è¿”å›æŒ‰éˆ• */
.back-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.9);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: bold;
    color: #4a5568;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.back-btn:hover {
    background: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* å–®å­—å¡ç‰‡ */
.word-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 600px;
    margin-top: 2rem;
}

.loading {
    text-align: center;
    font-size: 1.2rem;
    color: #666;
    padding: 2rem;
}

.word-info {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1rem;
}

.word-counter {
    background: #e2e8f0;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    color: #4a5568;
    font-weight: bold;
}

.word-display {
    text-align: center;
    margin-bottom: 2rem;
}

.word-main {
    margin-bottom: 2rem;
}

.word {
    font-size: 3rem;
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-weight: bold;
}

.spelling {
    font-size: 1.5rem;
    color: #718096;
    font-style: italic;
}

.meaning, .sentence {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f7fafc;
    border-radius: 10px;
    text-align: left;
}

.meaning h3, .sentence h3 {
    color: #4a5568;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.meaning p, .sentence p {
    color: #2d3748;
    font-size: 1.1rem;
    line-height: 1.6;
}

/* æ§åˆ¶æŒ‰éˆ• */
.controls {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
}

.control-btn {
    flex: 1;
    padding: 1rem;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.prev-btn {
    background: #cbd5e0;
    color: #4a5568;
}

.prev-btn:hover {
    background: #a0aec0;
    transform: translateY(-1px);
}

.sound-btn {
    background: #48bb78;
    color: white;
}

.sound-btn:hover {
    background: #38a169;
    transform: translateY(-1px);
}

.next-btn {
    background: #4299e1;
    color: white;
}

.next-btn:hover {
    background: #3182ce;
    transform: translateY(-1px);
}

.control-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.control-btn:disabled:hover {
    transform: none;
}

/* ä½”ä½é é¢ */
.placeholder {
    text-align: center;
    color: white;
    padding: 4rem 2rem;
}

.placeholder h2 {
    font-size: 2rem;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.placeholder p {
    font-size: 1.2rem;
    opacity: 0.9;
}

/* å•†åº—é é¢æ¨£å¼ */
.shop-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    width: 100%;
    max-width: 900px;
    margin-top: 2rem;
}

.shop-title {
    text-align: center;
    color: #2d3748;
    margin-bottom: 2rem;
    font-size: 2rem;
}

/* ç©å®¶ç‹€æ…‹å€ */
.player-stats {
    background: #f7fafc;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.player-stats h3 {
    color: #4a5568;
    margin-bottom: 1rem;
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-item {
    background: white;
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.stat-item:hover {
    transform: translateY(-2px);
}

.stat-icon {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 0.5rem;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: #718096;
    margin-bottom: 0.25rem;
}

.stat-value {
    display: block;
    font-size: 1.2rem;
    font-weight: bold;
    color: #2d3748;
}

.stat-item.points .stat-value {
    color: #d69e2e;
}

.stat-item.health .stat-value {
    color: #e53e3e;
}

.stat-item.defense .stat-value {
    color: #3182ce;
}

.stat-item.attack .stat-value {
    color: #38a169;
}

.stat-item.free-unlocks .stat-value {
    color: #9f7aea;
}

/* å•†åº—å€å¡Š */
.shop-sections {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.shop-section {
    border: 2px solid #e2e8f0;
    border-radius: 15px;
    padding: 1.5rem;
    background: #fafafa;
}

.shop-section h3 {
    color: #4a5568;
    margin-bottom: 1rem;
    font-size: 1.3rem;
}

.shop-item {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}

.shop-item:last-child {
    margin-bottom: 0;
}

.shop-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.item-info {
    flex: 1;
}

.item-info h4 {
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.item-info p {
    color: #718096;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.unlock-info {
    font-weight: bold;
    color: #4a5568 !important;
}

/* å‡ç´šç¶²æ ¼ */
.upgrade-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
}

.upgrade-grid .shop-item {
    margin-bottom: 0;
}

/* å•†åº—æŒ‰éˆ• */
.shop-btn {
    background: #4299e1;
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    min-width: 80px;
}

.shop-btn:hover {
    background: #3182ce;
    transform: translateY(-1px);
}

.shop-btn:disabled {
    background: #cbd5e0;
    color: #a0aec0;
    cursor: not-allowed;
}

.shop-btn:disabled:hover {
    transform: none;
}

.reset-btn {
    background: #48bb78;
}

.reset-btn:hover {
    background: #38a169;
}

.upgrade-btn {
    background: #ed8936;
}

.upgrade-btn:hover {
    background: #dd6b20;
}

.unlock-btn {
    background: #9f7aea;
}

.unlock-btn:hover {
    background: #805ad5;
}

.free-unlock-btn {
    background: #48bb78;
    margin-left: 0.5rem;
}

.free-unlock-btn:hover {
    background: #38a169;
}

.unlock-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

/* è¨Šæ¯é¡¯ç¤º */
.shop-message {
    text-align: center;
    padding: 1rem;
    margin-top: 1rem;
    border-radius: 8px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.shop-message.success {
    background: #c6f6d5;
    color: #22543d;
    border: 1px solid #9ae6b4;
}

.shop-message.error {
    background: #fed7d7;
    color: #742a2a;
    border: 1px solid #fc8181;
}

.shop-message.info {
    background: #bee3f8;
    color: #2a4365;
    border: 1px solid #90cdf4;
}

/* ==========================================
   Bossæˆ°é¬¥é é¢æ¨£å¼
   ========================================== */

/* Bosså®¹å™¨ */
.boss-container {
    position: relative;
    max-width: 1000px;
    padding: 20px;
}

/* ç‹€æ…‹æ¬„ */
.boss-status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 15px 25px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
    z-index: 100;
}

.boss-timer, .boss-health, .boss-round {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
}

.timer-label, .health-label, .round-label {
    color: #4a5568;
    font-size: 0.9rem;
}

.timer-display {
    color: #e53e3e;
    font-size: 1.5rem;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

.timer-unit {
    color: #718096;
    font-size: 0.9rem;
}

.health-display {
    color: #e53e3e;
    font-size: 1.2rem;
}

.round-display {
    color: #4299e1;
    font-size: 1.2rem;
}

/* æˆ°é¬¥å€åŸŸ */
.boss-battle-area {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    min-height: 500px;
    position: relative;
}

/* é–‹å§‹ç•«é¢ */
.boss-start-screen {
    text-align: center;
    padding: 2rem;
}

.boss-intro h2 {
    color: #2d3748;
    margin-bottom: 2rem;
    font-size: 2.5rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.boss-rules {
    background: #f7fafc;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    text-align: left;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.boss-rules h3 {
    color: #4a5568;
    margin-bottom: 1rem;
    text-align: center;
}

.boss-rules ul {
    list-style: none;
    padding: 0;
}

.boss-rules li {
    background: white;
    margin-bottom: 0.5rem;
    padding: 0.8rem;
    border-radius: 8px;
    color: #2d3748;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.boss-start-btn {
    background: linear-gradient(135deg, #e53e3e, #c53030);
    color: white;
    border: none;
    padding: 1.5rem 3rem;
    border-radius: 15px;
    font-size: 1.3rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.boss-start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(229, 62, 62, 0.4);
}

.boss-start-btn:active {
    transform: translateY(0);
}

/* éŠæˆ²ç•«é¢ */
.boss-game-screen {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    height: 100%;
}

.question-area {
    text-align: center;
    margin-bottom: 1rem;
}

.question-type {
    background: #4299e1;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
    display: inline-block;
    margin-bottom: 1rem;
}

.question-content {
    background: #f7fafc;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.question-content h3 {
    color: #4a5568;
    margin-bottom: 1rem;
}

.question-text {
    color: #2d3748;
    font-size: 1.2rem;
    font-weight: bold;
    line-height: 1.6;
}

/* ç­”æ¡ˆé¸é … */
.answer-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

.answer-btn {
    background: white;
    border: 2px solid #e2e8f0;
    padding: 1.5rem 1rem;
    border-radius: 12px;
    font-size: 1rem;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.4;
}

.answer-btn:hover {
    border-color: #4299e1;
    background: #ebf8ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
}

.answer-btn:active {
    transform: translateY(0);
}

.answer-btn.correct {
    background: #c6f6d5;
    border-color: #38a169;
    color: #22543d;
}

.answer-btn.wrong {
    background: #fed7d7;
    border-color: #e53e3e;
    color: #742a2a;
}

.answer-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.answer-btn:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* å¾—åˆ†é¡¯ç¤º */
.boss-score {
    text-align: center;
    background: #ffd700;
    padding: 1rem;
    border-radius: 10px;
    font-weight: bold;
    font-size: 1.2rem;
    color: #744210;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}

/* çµæŸç•«é¢ */
.boss-end-screen {
    text-align: center;
    padding: 2rem;
}

.end-result {
    margin-bottom: 2rem;
}

.victory-screen {
    color: #22543d;
}

.victory-screen h2 {
    color: #38a169;
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.defeat-screen {
    color: #742a2a;
}

.defeat-screen h2 {
    color: #e53e3e;
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.final-score {
    background: #ffd700;
    padding: 1rem 2rem;
    border-radius: 15px;
    margin: 1rem 0;
    font-size: 1.5rem;
    font-weight: bold;
    color: #744210;
}

.boss-restart-btn, .boss-main-btn {
    background: #4299e1;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    margin: 0.5rem;
    transition: all 0.3s ease;
}

.boss-restart-btn:hover, .boss-main-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(66, 153, 225, 0.3);
}

.boss-restart-btn {
    background: #38a169;
}

.boss-restart-btn:hover {
    box-shadow: 0 4px 15px rgba(56, 161, 105, 0.3);
}

/* ç‰¹æ•ˆå€åŸŸ */
.boss-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
}

/* ç«æŸ±ç‰¹æ•ˆ */
.fire-effect {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 200px;
    background: linear-gradient(to top, #ff4500, #ff6347, #ffa500, transparent);
    border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
    animation: fireFlicker 0.5s ease-in-out;
    opacity: 0.8;
}

@keyframes fireFlicker {
    0%, 100% {
        transform: translateX(-50%) scale(1);
        opacity: 0.8;
    }
    50% {
        transform: translateX(-50%) scale(1.2);
        opacity: 1;
    }
}

/* æµè¡€ç‰¹æ•ˆ */
.blood-effect {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, transparent, rgba(255, 0, 0, 0.3));
    animation: bloodPulse 0.5s ease-in-out;
}

@keyframes bloodPulse {
    0%, 100% {
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
}

/* é‡‘å¹£ç‰¹æ•ˆ */
.coin-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 3rem;
    color: #ffd700;
    animation: coinDrop 0.5s ease-out;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

@keyframes coinDrop {
    0% {
        transform: translate(-50%, -150%) scale(0);
        opacity: 0;
    }
    50% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.2);
    }
    100% {
        transform: translate(-50%, 50%) scale(1);
        opacity: 0;
    }
}

/* å¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ */
.score-popup {
    position: absolute;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #ffd700;
    color: #744210;
    padding: 1rem 2rem;
    border-radius: 15px;
    font-size: 1.5rem;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
    animation: scorePopup 0.5s ease-out;
}

@keyframes scorePopup {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
    50% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    #main-page h1 {
        font-size: 2rem;
    }
    
    .word {
        font-size: 2.5rem;
    }
    
    .controls {
        flex-direction: column;
    }
    
    .back-btn {
        position: relative;
        top: 0;
        right: 0;
        margin-bottom: 1rem;
        align-self: flex-end;
    }
    
    /* å•†åº—éŸ¿æ‡‰å¼ */
    .shop-content {
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .shop-title {
        font-size: 1.5rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
    
    .upgrade-grid {
        grid-template-columns: 1fr;
    }
    
    .shop-item {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .shop-item .shop-btn {
        width: 100%;
    }
    
    .unlock-buttons {
        justify-content: center;
    }
    
    .unlock-buttons .shop-btn {
        flex: 1;
        max-width: 120px;
    }
    
    /* Bossæˆ°é¬¥éŸ¿æ‡‰å¼ */
    .boss-container {
        padding: 10px;
    }
    
    .boss-status-bar {
        flex-direction: column;
        gap: 10px;
        padding: 15px;
    }
    
    .boss-status-bar > div {
        justify-content: center;
    }
    
    .boss-intro h2 {
        font-size: 2rem;
    }
    
    .boss-rules {
        margin-bottom: 1.5rem;
        padding: 1rem;
    }
    
    .boss-start-btn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
    }
    
    .answer-options {
        grid-template-columns: 1fr;
        gap: 0.8rem;
    }
    
    .answer-btn {
        padding: 1rem;
        min-height: 60px;
        font-size: 0.9rem;
    }
    
    .boss-restart-btn, .boss-main-btn {
        display: block;
        width: 100%;
        margin: 0.5rem 0;
    }
}

```

ç¾åœ¨è®“æˆ‘æ›´æ–°ä»»å‹™ç‹€æ…‹ä¸¦é–‹å§‹å¯¦ç¾ Boss æˆ°é¬¥çš„ JavaScript é‚è¼¯ï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
    showDamageEffect();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¸æ“‡ç­”æ¡ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
        // æ’­æ”¾é‡‘å¹£éŸ³æ•ˆï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
        playSuccessSound();
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
        showDamageEffect();
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.spelling) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.spelling, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.spelling, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, spelling) => {
        // æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.spelling === spelling) {
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (${spelling}) å„ªå…ˆåº¦ç‚º ${newPriority}`);
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log('Bossæˆ°é¬¥çµæŸï¼Œå–®å­—å„ªå…ˆåº¦å·²æ›´æ–°');
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

```

ç¾åœ¨æˆ‘éœ€è¦å¯¦ç¾ç‰¹æ•ˆåŠŸèƒ½ã€‚è®“æˆ‘æ·»åŠ æˆ°é¬¥ç‰¹æ•ˆï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
    showDamageEffect();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¸æ“‡ç­”æ¡ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
        // æ’­æ”¾é‡‘å¹£éŸ³æ•ˆï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
        playSuccessSound();
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
        showDamageEffect();
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.spelling) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.spelling, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.spelling, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, spelling) => {
        // æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.spelling === spelling) {
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (${spelling}) å„ªå…ˆåº¦ç‚º ${newPriority}`);
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log('Bossæˆ°é¬¥çµæŸï¼Œå–®å­—å„ªå…ˆåº¦å·²æ›´æ–°');
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹handleTimeOutå’ŒselectAnswerå‡½æ•¸ä»¥åŒ…å«æµ®å‹•å‚·å®³ç‰¹æ•ˆ
const originalHandleTimeOut = handleTimeOut;
handleTimeOut = function() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
};

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨æˆ‘éœ€è¦å®Œæˆæœ€å¾Œçš„æˆ°é¬¥çµæŸç•«é¢åŠŸèƒ½ï¼Œä¸¦æ›´æ–°ä»»å‹™ç‹€æ…‹ï¼š

è®“æˆ‘æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•èªæ³•éŒ¯èª¤æˆ–éœ€è¦ä¿®å¾©çš„å•é¡Œï¼š

è®“æˆ‘æª¢æŸ¥HTMLæª”æ¡ˆæ˜¯å¦æœ‰éŒ¯èª¤ï¼š

æª¢æŸ¥CSSæ–‡ä»¶ï¼š

ç¾åœ¨è®“æˆ‘æª¢æŸ¥æ˜¯å¦æœ‰ä¸€å€‹é‡è¤‡å®šç¾©çš„å‡½æ•¸å•é¡Œï¼Œæˆ‘æ³¨æ„åˆ°æˆ‘å®šç¾©äº†å…©æ¬¡ `showDamageEffect` å‡½æ•¸ã€‚è®“æˆ‘ä¿®å¾©é€™å€‹å•é¡Œï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
    showDamageEffect();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¸æ“‡ç­”æ¡ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
        // æ’­æ”¾é‡‘å¹£éŸ³æ•ˆï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
        playSuccessSound();
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
        showDamageEffect();
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.spelling) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.spelling, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.spelling, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, spelling) => {
        // æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.spelling === spelling) {
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (${spelling}) å„ªå…ˆåº¦ç‚º ${newPriority}`);
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log('Bossæˆ°é¬¥çµæŸï¼Œå–®å­—å„ªå…ˆåº¦å·²æ›´æ–°');
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹handleTimeOutå’ŒselectAnswerå‡½æ•¸ä»¥åŒ…å«æµ®å‹•å‚·å®³ç‰¹æ•ˆ
const originalHandleTimeOut = handleTimeOut;
handleTimeOut = function() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
};

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

æˆ‘é‚„éœ€è¦ä¿®å¾© `handleTimeOut` å‡½æ•¸çš„é‡è¤‡å®šç¾©å•é¡Œï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
    showDamageEffect();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¸æ“‡ç­”æ¡ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
        // æ’­æ”¾é‡‘å¹£éŸ³æ•ˆï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
        playSuccessSound();
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
        showDamageEffect();
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.spelling) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.spelling, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.spelling, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, spelling) => {
        // æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.spelling === spelling) {
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (${spelling}) å„ªå…ˆåº¦ç‚º ${newPriority}`);
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log('Bossæˆ°é¬¥çµæŸï¼Œå–®å­—å„ªå…ˆåº¦å·²æ›´æ–°');
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹å¾Œçš„handleTimeOutå‡½æ•¸ï¼ˆæ›¿æ›åŸæœ¬çš„ç‰ˆæœ¬ï¼‰
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨æˆ‘éœ€è¦åˆªé™¤åŸä¾†çš„ `handleTimeOut` å‡½æ•¸å®šç¾©ï¼Œä¸¦ç¢ºä¿ `selectAnswer` ä¸æœƒé‡è¤‡å®šç¾©ï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚ï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¸æ“‡ç­”æ¡ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
        // æ’­æ”¾é‡‘å¹£éŸ³æ•ˆï¼ˆå¦‚æœç€è¦½å™¨æ”¯æ´ï¼‰
        playSuccessSound();
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆ
        showDamageEffect();
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.spelling) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.spelling, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.spelling, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, spelling) => {
        // æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.spelling === spelling) {
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (${spelling}) å„ªå…ˆåº¦ç‚º ${newPriority}`);
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log('Bossæˆ°é¬¥çµæŸï¼Œå–®å­—å„ªå…ˆåº¦å·²æ›´æ–°');
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹å¾Œçš„handleTimeOutå‡½æ•¸ï¼ˆæ›¿æ›åŸæœ¬çš„ç‰ˆæœ¬ï¼‰
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨æˆ‘éœ€è¦åˆªé™¤é‡è¤‡çš„ `selectAnswer` å‡½æ•¸ï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚ï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¸æ“‡ç­”æ¡ˆï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.spelling) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.spelling, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.spelling, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, spelling) => {
        // æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.spelling === spelling) {
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (${spelling}) å„ªå…ˆåº¦ç‚º ${newPriority}`);
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log('Bossæˆ°é¬¥çµæŸï¼Œå–®å­—å„ªå…ˆåº¦å·²æ›´æ–°');
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹å¾Œçš„handleTimeOutå‡½æ•¸ï¼ˆæ›¿æ›åŸæœ¬çš„ç‰ˆæœ¬ï¼‰
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨è®“æˆ‘æ¸¬è©¦ç¶²é æ˜¯å¦èƒ½æ­£å¸¸è¼‰å…¥ã€‚å…ˆå‰µå»ºä¸€å€‹ç°¡å–®çš„æ¸¬è©¦æŒ‡ä»¤ä¾†é–‹å•Ÿç€è¦½å™¨ï¼š

è®“æˆ‘ç”¨æ­£ç¢ºçš„ PowerShell èªæ³•ï¼š

è®“æˆ‘æª¢æŸ¥æ˜¯å¦æ‰€æœ‰åŠŸèƒ½éƒ½å·²å®Œæˆï¼Œä¸¦å‰µå»ºä¸€å€‹ç¸½çµï¼š

## Boss æˆ°é¬¥ç³»çµ±å¯¦ç¾å®Œæˆï¼ğŸ‰

æˆ‘å·²ç¶“æˆåŠŸä¾ç…§æ‚¨çš„è¦æ±‚å®Œæˆäº†å®Œæ•´çš„ Boss æˆ°é¬¥å­ç¶²é ç³»çµ±ã€‚ä»¥ä¸‹æ˜¯å¯¦ç¾çš„ä¸»è¦åŠŸèƒ½ï¼š

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

#### 1. ç•Œé¢è¨­è¨ˆ
- **é–‹å§‹ç•«é¢**ï¼šåŒ…å«æˆ°é¬¥è¦å‰‡èªªæ˜å’Œé–‹å§‹æŒ‰éˆ•
- **ç‹€æ…‹æ¬„**ï¼šé¡¯ç¤ºå€’æ•¸è¨ˆæ™‚å™¨ã€ç”Ÿå‘½å€¼ã€å›åˆæ•¸
- **éŠæˆ²å€åŸŸ**ï¼šå•é¡Œé¡¯ç¤ºã€å››å€‹é¸é …æŒ‰éˆ•ã€å¾—åˆ†é¡¯ç¤º
- **çµæŸç•«é¢**ï¼šå‹åˆ©/å¤±æ•—åˆ¤å®šå’Œçµæœå±•ç¤º

#### 2. æˆ°é¬¥é‚è¼¯
- **20å›åˆåˆ¶**ï¼šç¸½å…±é€²è¡Œ20å€‹å›åˆçš„æˆ°é¬¥
- **è¨ˆæ™‚ç³»çµ±**ï¼šæ¯å›åˆæ™‚é–“é™åˆ¶ç‚ºç©å®¶æ”»æ“ŠåŠ›çš„ç§’æ•¸
- **ç”Ÿå‘½å€¼ç³»çµ±**ï¼šç­”éŒ¯æˆ–è¶…æ™‚æ‰£2é»ç”Ÿå‘½å€¼
- **å¾—åˆ†è¨ˆç®—**ï¼šç­”å°å¾—åˆ† = å‰©é¤˜æ™‚é–“ + é˜²ç¦¦å€¼ - 13ï¼ˆæ¨å»å°æ•¸ï¼‰

#### 3. æ¸¬é©—æ¨¡å¼ï¼ˆéš¨æ©Ÿé¸æ“‡ï¼‰
- **ä¾‹å¥é¸æ„æ€**ï¼šçµ¦æ—¥æ–‡ä¾‹å¥ï¼Œé¸æ“‡å°æ‡‰çš„ä¸­æ–‡æ„æ€
- **æ„æ€é¸ä¾‹å¥**ï¼šçµ¦ä¸­æ–‡æ„æ€ï¼Œé¸æ“‡å°æ‡‰çš„æ—¥æ–‡ä¾‹å¥  
- **å¡«ç©ºé¡Œ**ï¼šå°‡ä¾‹å¥ä¸­çš„`<å–®å­—>`æŒ–ç©ºï¼Œé¸æ“‡æ­£ç¢ºå¡«å…¥çš„å–®å­—

#### 4. å„ªå…ˆéšŠåˆ—ç³»çµ±
- ä½¿ç”¨ Priority Queue æŒ‰å„ªå…ˆåº¦ç”±å°åˆ°å¤§æ’åºå–®å­—
- åŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åˆ—
- ç­”å°ï¼špriority += 1ï¼Œç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1

#### 5. è¦–è¦ºç‰¹æ•ˆ
- **ç­”éŒ¯ç‰¹æ•ˆ**ï¼šç«æŸ±å‹•ç•« + æµè¡€æ•ˆæœ + æµ®å‹•å‚·å®³æ•¸å­—
- **ç­”å°ç‰¹æ•ˆ**ï¼šé‡‘å¹£æ‰è½å‹•ç•« + å¾—åˆ†å½ˆå‡ºé¡¯ç¤º
- **éŸ³æ•ˆç³»çµ±**ï¼šä½¿ç”¨ Web Audio API ç”¢ç”Ÿé‡‘å¹£å’ŒéŒ¯èª¤éŸ³æ•ˆ

#### 6. çµæŸæ¢ä»¶èˆ‡ç•«é¢
- **å‹åˆ©æ¢ä»¶**ï¼šå®Œæˆ20å›åˆä¸”ç”Ÿå‘½å€¼ > 0
- **å¤±æ•—æ¢ä»¶**ï¼šç”Ÿå‘½å€¼ â‰¤ 0
- **å‹åˆ©ç•«é¢**ï¼šé¡¯ç¤ºç²å¾—çš„é»æ•¸ä¸¦è‡ªå‹•åŠ å…¥å¸³æˆ¶
- **å¤±æ•—ç•«é¢**ï¼šå¾—åˆ†æ­¸é›¶ï¼Œé¡¯ç¤ºæŒ‘æˆ°å¤±æ•—è¨Šæ¯

#### 7. æŒ‰éˆ•æ§åˆ¶
- æˆ°é¬¥é–‹å§‹å¾Œè¿”å›æŒ‰éˆ•æœƒè¢« disabled
- æˆ°é¬¥çµæŸå¾Œè¿”å›æŒ‰éˆ•é‡æ–°å•Ÿç”¨
- æˆ°é¬¥ä¸­è¿”å›ä¸»é é¢éœ€è¦ç¢ºèª

#### 8. éŸ¿æ‡‰å¼è¨­è¨ˆ
- æ”¯æ´æ‰‹æ©Ÿå’Œæ¡Œé¢è¨­å‚™
- è‡ªé©æ‡‰å¸ƒå±€å’Œå­—é«”å¤§å°

### ğŸ® ä½¿ç”¨æ–¹å¼

1. é»æ“Šä¸»é é¢çš„ã€ŒBossæˆ°é¬¥ã€æŒ‰éˆ•
2. æŸ¥çœ‹æˆ°é¬¥è¦å‰‡ï¼Œé»æ“Šã€Œé–‹å§‹æˆ°é¬¥ã€
3. åœ¨æ™‚é–“é™åˆ¶å…§é¸æ“‡æ­£ç¢ºç­”æ¡ˆ
4. å®Œæˆ20å›åˆæˆ–ç”Ÿå‘½å€¼æ­¸é›¶æ™‚æˆ°é¬¥çµæŸ
5. æŸ¥çœ‹æˆ°é¬¥çµæœå’Œç²å¾—çš„é»æ•¸

ç³»çµ±æœƒè‡ªå‹•ä¿å­˜éŠæˆ²é€²åº¦ï¼ŒåŒ…æ‹¬æ›´æ–°å¾Œçš„å–®å­—å„ªå…ˆåº¦å’Œç©å®¶é»æ•¸ã€‚æ‰€æœ‰ç‰¹æ•ˆéƒ½è¨­å®šç‚º0.5ç§’çš„æŒçºŒæ™‚é–“ï¼Œä¸æœƒå½±éŸ¿éŠæˆ²è¨ˆæ™‚ã€‚

Bossæˆ°é¬¥ç³»çµ±ç¾åœ¨å·²ç¶“å®Œå…¨å¯ç”¨ï¼Œæ‚¨å¯ä»¥åœ¨ç€è¦½å™¨ä¸­æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½ï¼

---

**User**

ä½ çš„é‚è¼¯æœ‰èª¤ï¼Œæˆ‘é‚„åŸéŠæˆ²å¾Œåªæœ‰20å€‹å–®å­—ç„¶å¾Œåœ¨æŒ‘æˆ°æ¨¡å¼ä¸‹æŒ‘æˆ°å¤±æ•—å–®å­—å»è®Šæˆ43å€‹ï¼Œæˆ‘åœ¨æƒ³ä½ æ˜¯ä¸æ˜¯æŠŠç”¨æ–¼ä½œç‚ºé¸é …çš„å–®å­—ï¼ŒpriorityåŸæœ¬ç‚º0çš„ä¹Ÿè®Šæˆ1äº†

---

**Cursor**

æ‚¨èªªå¾—å°ï¼æˆ‘æª¢æŸ¥äº†ä»£ç¢¼ï¼Œç™¼ç¾ç¢ºå¯¦æœ‰é‚è¼¯éŒ¯èª¤ã€‚åœ¨ç”Ÿæˆé¸é …æ™‚ï¼Œæˆ‘ä½¿ç”¨äº†æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬ priority ç‚º 0 çš„æœªè§£é–å–®å­—ï¼‰ä½œç‚ºéŒ¯èª¤é¸é …ï¼Œä½†åœ¨æ›´æ–°å„ªå…ˆåº¦æ™‚æ²’æœ‰æ­£ç¢ºå€åˆ†å“ªäº›å–®å­—æ˜¯å¯¦éš›åƒèˆ‡æ¸¬é©—çš„ã€‚

è®“æˆ‘æª¢æŸ¥ä¸¦ä¿®å¾©é€™å€‹å•é¡Œï¼š

æˆ‘æ‰¾åˆ°å•é¡Œäº†ï¼åœ¨ `updateWordPriority` å‡½æ•¸ä¸­ï¼Œæˆ‘åªæ›´æ–°äº† `bossGameState.currentQuestion` é€™å€‹å–®å­—çš„å„ªå…ˆåº¦ï¼Œé€™æ˜¯æ­£ç¢ºçš„ã€‚ä½†å•é¡Œå¯èƒ½å‡ºç¾åœ¨å…¶ä»–åœ°æ–¹ã€‚è®“æˆ‘æª¢æŸ¥ `applyWordPriorityUpdates` å‡½æ•¸ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰é‚è¼¯éŒ¯èª¤ï¼š

å•é¡Œæ‰¾åˆ°äº†ï¼åœ¨ `applyWordPriorityUpdates` å‡½æ•¸ä¸­ï¼Œæˆ‘ä½¿ç”¨äº† `word.spelling === spelling` ä¾†æ¯”å°ï¼Œä½†æ˜¯å¦‚æœæœ‰å¤šå€‹å–®å­—å…·æœ‰ç›¸åŒçš„ spellingï¼ˆä¸€å­—å¤šç¾©çš„æƒ…æ³ï¼‰ï¼Œæ‰€æœ‰ç›¸åŒ spelling çš„å–®å­—éƒ½æœƒè¢«æ›´æ–°å„ªå…ˆåº¦ã€‚

è®“æˆ‘æª¢æŸ¥ words_data.js ä¸­æ˜¯å¦çœŸçš„æœ‰é‡è¤‡çš„ spellingï¼š

---

**User**

æˆ‘å»ºè­°åœ¨data.jsæ¯å€‹å–®å­—ä¸­åŠ å…¥word_idï¼Œword_idå…·å‚™å”¯ä¸€çš„æ€§è³ªï¼Œåœ¨å¯«æª”æ¡ˆæ™‚ä¹Ÿèƒ½æ ¹æ“šidæ‰¾åˆ°å”¯ä¸€çš„å–®å­—ï¼Œå°±ä¸æœƒå†æ›´æ–°priorityæ™‚ä¾¿å‹•åˆ°å…¶ä»–spellingä¸€æ¨£ä½†æ„ç¾©ä¸åŒçš„å–®å­—ï¼Œè«‹ç”¨é€™å€‹æ–¹å¼å»æ”¹

---

**Cursor**

æ‚¨çš„å»ºè­°éå¸¸å¥½ï¼ä½¿ç”¨å”¯ä¸€çš„ `word_id` ä¾†è­˜åˆ¥å–®å­—æ˜¯æœ€ä½³è§£æ±ºæ–¹æ¡ˆã€‚è®“æˆ‘ä¿®æ”¹ä»£ç¢¼ä¾†å¯¦ç¾é€™å€‹æ–¹æ¡ˆã€‚

é¦–å…ˆï¼Œæˆ‘éœ€è¦ç‚ºæ¯å€‹å–®å­—æ·»åŠ å”¯ä¸€çš„ `word_id`ï¼š

æˆ‘éœ€è¦å‰µå»ºä¸€å€‹è…³æœ¬ä¾†ç‚ºæ‰€æœ‰å–®å­—æ·»åŠ å”¯ä¸€çš„ `word_id`ã€‚è®“æˆ‘å‰µå»ºä¸€å€‹ Python è…³æœ¬ä¾†è™•ç†é€™å€‹ä»»å‹™ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç‚º words_data.js ä¸­çš„æ¯å€‹å–®å­—æ·»åŠ å”¯ä¸€çš„ word_id
"""

import re
import json

def add_word_ids():
    # è®€å–åŸå§‹æª”æ¡ˆ
    with open('words_data.js', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # æå– WORDS_DATA é™£åˆ—
    match = re.search(r'const WORDS_DATA = (\[.*\]);', content, re.DOTALL)
    if not match:
        print("ç„¡æ³•æ‰¾åˆ° WORDS_DATA é™£åˆ—")
        return
    
    # è§£æ JSON è³‡æ–™
    words_data_str = match.group(1)
    # ç§»é™¤ JavaScript è¨»è§£ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    words_data_str = re.sub(r'//.*$', '', words_data_str, flags=re.MULTILINE)
    
    try:
        words_data = json.loads(words_data_str)
    except json.JSONDecodeError as e:
        print(f"JSON è§£æéŒ¯èª¤: {e}")
        return
    
    # ç‚ºæ¯å€‹å–®å­—æ·»åŠ  word_id
    for i, word in enumerate(words_data):
        word['word_id'] = i + 1  # å¾ 1 é–‹å§‹çš„å”¯ä¸€ ID
    
    # é‡æ–°ç”Ÿæˆæª”æ¡ˆå…§å®¹
    new_content = f"""// è‡ªå‹•ç”Ÿæˆçš„å–®å­—è³‡æ–™æª”æ¡ˆ
// ä¾†æº: JP_words.xlsx
// ç”Ÿæˆæ™‚é–“: 2025-09-27 17:24:56
// æ›´æ–°æ™‚é–“: 2025-09-27 (æ·»åŠ  word_id)

const WORDS_DATA = {json.dumps(words_data, ensure_ascii=False, indent=2)};

// æ”¯æ´Node.jsç’°å¢ƒ
if (typeof module !== 'undefined' && module.exports) {{
    module.exports = {{ WORDS_DATA }};
}}
"""
    
    # å¯«å…¥æ–°æª”æ¡ˆ
    with open('words_data.js', 'w', encoding='utf-8') as f:
        f.write(new_content)
    
    print(f"æˆåŠŸç‚º {len(words_data)} å€‹å–®å­—æ·»åŠ äº† word_id")

if __name__ == "__main__":
    add_word_ids()
```

å¾ˆå¥½ï¼ç¾åœ¨è®“æˆ‘æª¢æŸ¥æ·»åŠ  `word_id` å¾Œçš„æ•ˆæœï¼š

å®Œç¾ï¼ç¾åœ¨æ¯å€‹å–®å­—éƒ½æœ‰å”¯ä¸€çš„ `word_id`ã€‚æ¥ä¸‹ä¾†æˆ‘éœ€è¦ä¿®æ”¹ Boss æˆ°é¬¥çš„ JavaScript ä»£ç¢¼ï¼Œä½¿ç”¨ `word_id` è€Œä¸æ˜¯ `spelling` ä¾†è¿½è¹¤å’Œæ›´æ–°å–®å­—å„ªå…ˆåº¦ï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚ï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¸æ“‡ç­”æ¡ˆï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.word_id) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.word_id, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.word_id, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, spelling) => {
        // æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.spelling === spelling) {
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (${spelling}) å„ªå…ˆåº¦ç‚º ${newPriority}`);
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log('Bossæˆ°é¬¥çµæŸï¼Œå–®å­—å„ªå…ˆåº¦å·²æ›´æ–°');
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹å¾Œçš„handleTimeOutå‡½æ•¸ï¼ˆæ›¿æ›åŸæœ¬çš„ç‰ˆæœ¬ï¼‰
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨ä¿®æ”¹ `applyWordPriorityUpdates` å‡½æ•¸ï¼Œä½¿ç”¨ `word_id` ä¾†ç²¾ç¢ºå®šä½å–®å­—ï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord.spelling && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚ï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¸æ“‡ç­”æ¡ˆï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.word_id) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.word_id, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.word_id, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, wordId) => {
        // ä½¿ç”¨ word_id æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.word_id === wordId) {
                const oldPriority = word.priority;
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (ID: ${wordId}, ${word.spelling}) å„ªå…ˆåº¦: ${oldPriority} â†’ ${newPriority}`);
                break; // æ‰¾åˆ°å”¯ä¸€åŒ¹é…å¾Œç«‹å³ä¸­æ–·ï¼Œé¿å…ç¹¼çºŒæœå°‹
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log(`Bossæˆ°é¬¥çµæŸï¼Œå…±æ›´æ–°äº† ${bossGameState.wordPriorityUpdates.size} å€‹å–®å­—çš„å„ªå…ˆåº¦`);
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹å¾Œçš„handleTimeOutå‡½æ•¸ï¼ˆæ›¿æ›åŸæœ¬çš„ç‰ˆæœ¬ï¼‰
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨æˆ‘éœ€è¦ä¿®æ”¹ `generateOptions` å‡½æ•¸ï¼Œç¢ºä¿åœ¨æª¢æŸ¥æ‹¼éŸ³æ˜¯å¦ç›¸åŒæ™‚ä¹Ÿä½¿ç”¨ `word_id` ä¾†é¿å…é‡è¤‡ï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.word_id !== correctWord.word_id && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.spelling !== correctWord && wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚ï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¸æ“‡ç­”æ¡ˆï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.word_id) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.word_id, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.word_id, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, wordId) => {
        // ä½¿ç”¨ word_id æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.word_id === wordId) {
                const oldPriority = word.priority;
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (ID: ${wordId}, ${word.spelling}) å„ªå…ˆåº¦: ${oldPriority} â†’ ${newPriority}`);
                break; // æ‰¾åˆ°å”¯ä¸€åŒ¹é…å¾Œç«‹å³ä¸­æ–·ï¼Œé¿å…ç¹¼çºŒæœå°‹
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log(`Bossæˆ°é¬¥çµæŸï¼Œå…±æ›´æ–°äº† ${bossGameState.wordPriorityUpdates.size} å€‹å–®å­—çš„å„ªå…ˆåº¦`);
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹å¾Œçš„handleTimeOutå‡½æ•¸ï¼ˆæ›¿æ›åŸæœ¬çš„ç‰ˆæœ¬ï¼‰
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨ä¹Ÿéœ€è¦ä¿®æ”¹ `generateFillInBlankOptions` å‡½æ•¸ï¼š

```javascript
// å…¨åŸŸè®Šæ•¸
let wordsData = [];
let reviewWords = [];
let currentWordIndex = 0;

// é é¢åˆ‡æ›å‡½æ•¸
function showPage(pageId) {
    // éš±è—æ‰€æœ‰é é¢
    const pages = document.querySelectorAll('.page');
    pages.forEach(page => page.classList.remove('active'));
    
    // é¡¯ç¤ºç›®æ¨™é é¢
    document.getElementById(pageId).classList.add('active');
    
    // å¦‚æœåˆ‡æ›åˆ°è¤‡ç¿’é é¢ï¼Œé‡æ–°æ’åºå–®å­—
    if (pageId === 'review-page' && wordsData.length > 0) {
        setupReviewMode();
    }
    
    // å¦‚æœåˆ‡æ›åˆ°å•†åº—é é¢ï¼Œæ›´æ–°é¡¯ç¤º
    if (pageId === 'shop-page') {
        updateShopDisplay();
    }
}

// è¼‰å…¥Excelæª”æ¡ˆ
function loadExcelFile() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    mainStatus.textContent = 'æ­£åœ¨è¼‰å…¥å–®å­—æª”æ¡ˆ...';
    mainStatus.className = 'loading-status';
    
    fetch('JP_words.xlsx')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.arrayBuffer();
        })
        .then(data => {
            try {
                const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                
                // è®€å–ç¬¬ä¸€å€‹å·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½‰æ›ç‚ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // è§£æè³‡æ–™
                parseWordsData(jsonData);
                
                // æ›´æ–°UIç‹€æ…‹
                mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                mainStatus.className = 'loading-status success';
                
                if (loadingMessage) {
                    loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
                }
                
            } catch (error) {
                console.error('æª”æ¡ˆè§£æéŒ¯èª¤:', error);
                mainStatus.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                mainStatus.className = 'loading-status error';
                
                if (loadingMessage) {
                    loadingMessage.textContent = 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢º';
                }
            }
        })
        .catch(error => {
            console.error('æª”æ¡ˆè¼‰å…¥éŒ¯èª¤:', error);
            mainStatus.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            mainStatus.className = 'loading-status error';
            
            if (loadingMessage) {
                loadingMessage.textContent = 'æ‰¾ä¸åˆ° JP_words.xlsx æª”æ¡ˆï¼Œè«‹ç¢ºèªæª”æ¡ˆä½æ–¼æ­£ç¢ºä½ç½®';
            }
        });
}

// è§£æå–®å­—è³‡æ–™
function parseWordsData(jsonData) {
    wordsData = [];
    
    if (jsonData.length < 2) {
        console.error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šéœ€è¦è‡³å°‘å…©è¡Œè³‡æ–™');
        return;
    }
    
    // ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
    const headers = jsonData[0];
    console.log('æª”æ¡ˆæ¨™é¡Œ:', headers);
    
    // å¾ç¬¬äºŒè¡Œé–‹å§‹æ˜¯è³‡æ–™
    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (row.length < 5) continue; // ç¢ºä¿æœ‰è¶³å¤ çš„æ¬„ä½
        
        const word = {
            word: row[0] || '',        // Word (æ—¥æ–‡å–®å­—)
            spelling: row[1] || '',    // Spelling (50éŸ³æ‹¼éŸ³)
            meaning: row[2] || '',     // Meaning (ä¸­æ–‡è§£é‡‹)
            sentence: row[3] || '',    // Sentence (ä¾‹å¥)
            priority: parseInt(row[4]) || 0  // Priority (å„ªå…ˆåº¦)
        };
        
        wordsData.push(word);
    }
    
    console.log('è¼‰å…¥çš„å–®å­—è³‡æ–™:', wordsData);
    setupReviewMode();
}

// è¨­å®šè¤‡ç¿’æ¨¡å¼
function setupReviewMode() {
    // ç¯©é¸å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)
    const availableWords = wordsData.filter(word => word.priority > 0);
    
    if (availableWords.length === 0) {
        document.getElementById('loading-message').textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­— (Priority > 0)';
        return;
    }
    
    // æŒ‰Priorityåˆ†çµ„
    const priorityGroups = {};
    availableWords.forEach(word => {
        if (!priorityGroups[word.priority]) {
            priorityGroups[word.priority] = [];
        }
        priorityGroups[word.priority].push(word);
    });
    
    // æ’åºï¼šå…ˆæŒ‰Priorityç”±å°åˆ°å¤§ï¼ŒåŒPriorityå…§éš¨æ©Ÿæ’åº
    reviewWords = [];
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        // éš¨æ©Ÿæ’åºåŒå„ªå…ˆåº¦çš„å–®å­—
        shuffleArray(group);
        reviewWords.push(...group);
    });
    
    console.log('è¤‡ç¿’é †åº:', reviewWords);
    
    // é‡ç½®åˆ°ç¬¬ä¸€å€‹å–®å­—
    currentWordIndex = 0;
    updateWordDisplay();
}

// é™£åˆ—éš¨æ©Ÿæ’åºå‡½æ•¸
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// æ›´æ–°ä¸»é é¢ç‹€æ…‹é¡¯ç¤º
function updateMainPageStatus() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    if (reviewWords.length > 0) {
        mainStatus.textContent = `æˆåŠŸè¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        mainStatus.className = 'loading-status success';
        
        if (loadingMessage) {
            loadingMessage.textContent = `å·²è¼‰å…¥ ${reviewWords.length} å€‹å¯è¤‡ç¿’çš„å–®å­—ï¼`;
        }
    } else {
        mainStatus.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å‰å¾€å•†åº—è§£é–æ–°å–®å­—';
        }
    }
}

// æ›´æ–°å–®å­—é¡¯ç¤º
function updateWordDisplay() {
    if (reviewWords.length === 0) {
        document.getElementById('word-content').style.display = 'none';
        document.getElementById('loading-message').style.display = 'block';
        return;
    }
    
    document.getElementById('loading-message').style.display = 'none';
    document.getElementById('word-content').style.display = 'block';
    
    const currentWord = reviewWords[currentWordIndex];
    
    // æ›´æ–°å–®å­—è³‡è¨Š
    document.getElementById('word-text').textContent = currentWord.word;
    document.getElementById('spelling-text').textContent = currentWord.spelling;
    document.getElementById('meaning-text').textContent = currentWord.meaning;
    
    // è™•ç†ä¾‹å¥ï¼ˆç§»é™¤<ç¬¦è™Ÿï¼Œä½†ä¿ç•™å–®å­—æ¨™è¨˜ç”¨æ–¼é«˜äº®ï¼‰
    let sentenceDisplay = currentWord.sentence;
    if (sentenceDisplay.includes('<') && sentenceDisplay.includes('>')) {
        // æå–è¢«<>åŒ…åœçš„å–®å­—ç”¨æ–¼é«˜äº®
        sentenceDisplay = sentenceDisplay.replace(/<([^>]+)>/g, '<span class="highlight">$1</span>');
    }
    document.getElementById('sentence-text').innerHTML = sentenceDisplay;
    
    // æ›´æ–°è¨ˆæ•¸å™¨
    document.getElementById('current-word-index').textContent = currentWordIndex + 1;
    document.getElementById('total-words').textContent = reviewWords.length;
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateButtonStates();
}

// æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
function updateButtonStates() {
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    prevBtn.disabled = currentWordIndex === 0;
    nextBtn.disabled = currentWordIndex === reviewWords.length - 1;
}

// ä¸Šä¸€å€‹å–®å­—
function previousWord() {
    if (currentWordIndex > 0) {
        currentWordIndex--;
        updateWordDisplay();
    }
}

// ä¸‹ä¸€å€‹å–®å­—
function nextWord() {
    if (currentWordIndex < reviewWords.length - 1) {
        currentWordIndex++;
        updateWordDisplay();
    }
}

// èªéŸ³æ’­æ”¾åŠŸèƒ½
function playSound() {
    if (reviewWords.length === 0) return;
    
    const currentWord = reviewWords[currentWordIndex];
    
    // ä½¿ç”¨Web Speech APIé€²è¡ŒèªéŸ³åˆæˆ
    if ('speechSynthesis' in window) {
        // åœæ­¢ç•¶å‰æ’­æ”¾
        speechSynthesis.cancel();
        
        // æ’­æ”¾å–®å­—æ‹¼éŸ³ï¼ˆæ—¥æ–‡ï¼‰
        const spellingUtterance = new SpeechSynthesisUtterance(currentWord.spelling);
        spellingUtterance.lang = 'ja-JP'; // æ—¥æ–‡
        spellingUtterance.rate = 0.8; // ç¨æ…¢çš„èªé€Ÿ
        
        // æ’­æ”¾ä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
        let sentenceToSpeak = currentWord.sentence.replace(/<[^>]*>/g, '');
        const sentenceUtterance = new SpeechSynthesisUtterance(sentenceToSpeak);
        sentenceUtterance.lang = 'ja-JP';
        sentenceUtterance.rate = 0.7;
        
        // å…ˆæ’­æ”¾æ‹¼éŸ³ï¼Œå†æ’­æ”¾ä¾‹å¥
        spellingUtterance.onend = function() {
            setTimeout(() => {
                speechSynthesis.speak(sentenceUtterance);
            }, 500); // é–“éš”0.5ç§’
        };
        
        speechSynthesis.speak(spellingUtterance);
        
        // è¦–è¦ºåé¥‹
        const soundBtn = document.querySelector('.sound-btn');
        soundBtn.style.background = '#2d3748';
        setTimeout(() => {
            soundBtn.style.background = '#48bb78';
        }, 1000);
        
    } else {
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
    }
}

// é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // æª¢æŸ¥æ˜¯å¦æœ‰åµŒå…¥çš„å–®å­—è³‡æ–™
    if (typeof WORDS_DATA !== 'undefined' && WORDS_DATA.length > 0) {
        // ä½¿ç”¨åµŒå…¥çš„å–®å­—è³‡æ–™
        loadFromEmbeddedData();
    } else {
        // å˜—è©¦è¼‰å…¥Excelæª”æ¡ˆ
        loadExcelFile();
    }
});

// å¾åµŒå…¥çš„è³‡æ–™è¼‰å…¥
function loadFromEmbeddedData() {
    const mainStatus = document.getElementById('main-loading-status');
    const loadingMessage = document.getElementById('loading-message');
    
    try {
        // é¦–å…ˆå˜—è©¦è¼‰å…¥å·²å„²å­˜çš„é€²åº¦
        const hasLoadedProgress = loadGameProgress();
        
        if (!hasLoadedProgress) {
            // æ²’æœ‰å„²å­˜çš„é€²åº¦ï¼Œä½¿ç”¨åµŒå…¥çš„è³‡æ–™åˆå§‹åŒ–
            // è¤‡è£½è³‡æ–™ä¸¦ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            wordsData = WORDS_DATA.map(word => ({
                ...word,
                priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½æ˜¯0
            }));
            
            // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºå¯è¤‡ç¿’ï¼ˆpriority > 0ï¼‰
            const availableWords = [...wordsData];
            shuffleArray(availableWords);
            for (let i = 0; i < Math.min(20, availableWords.length); i++) {
                availableWords[i].priority = Math.floor(Math.random() * 3) + 1; // éš¨æ©Ÿè¨­ç‚º1-3
            }
            
            // çµ¦äºˆåˆå§‹å…è²»è§£é–æ©Ÿæœƒ
            PLAYER_DATA.freeUnlocks = 1;
            
            // å„²å­˜åˆå§‹ç‹€æ…‹
            saveGameProgress();
            
            console.log('åˆå§‹åŒ–éŠæˆ²:', wordsData.length, 'å€‹å–®å­—');
        } else {
            console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
        }
        
        setupReviewMode();
        updateMainPageStatus();
        
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²è³‡æ–™éŒ¯èª¤:', error);
        mainStatus.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        mainStatus.className = 'loading-status error';
        
        if (loadingMessage) {
            loadingMessage.textContent = 'è¼‰å…¥éŠæˆ²è³‡æ–™å¤±æ•—';
        }
    }
}

// æ·»åŠ é«˜äº®æ¨£å¼
const style = document.createElement('style');
style.textContent = `
    .highlight {
        background-color: #ffd700;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 3px;
    }
`;
document.head.appendChild(style);

// ===================
// æœ¬åœ°å„²å­˜åŠŸèƒ½
// ===================

// å„²å­˜éŠæˆ²é€²åº¦
function saveGameProgress() {
    try {
        const gameData = {
            playerData: PLAYER_DATA,
            wordsData: wordsData,
            lastSaved: new Date().toISOString()
        };
        
        localStorage.setItem('japaneseWordGame', JSON.stringify(gameData));
        console.log('éŠæˆ²é€²åº¦å·²å„²å­˜');
    } catch (error) {
        console.error('å„²å­˜éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// è¼‰å…¥éŠæˆ²é€²åº¦
function loadGameProgress() {
    try {
        const savedData = localStorage.getItem('japaneseWordGame');
        if (savedData) {
            const gameData = JSON.parse(savedData);
            
            // è¼‰å…¥ç©å®¶è³‡æ–™
            Object.assign(PLAYER_DATA, gameData.playerData);
            
            // è¼‰å…¥å–®å­—è³‡æ–™
            if (gameData.wordsData && gameData.wordsData.length > 0) {
                wordsData = gameData.wordsData;
                console.log('è¼‰å…¥å·²å„²å­˜çš„éŠæˆ²é€²åº¦');
                return true;
            }
        }
    } catch (error) {
        console.error('è¼‰å…¥éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
    return false;
}

// æ¸…é™¤å„²å­˜çš„éŠæˆ²é€²åº¦
function clearGameProgress() {
    try {
        localStorage.removeItem('japaneseWordGame');
        console.log('éŠæˆ²é€²åº¦å·²æ¸…é™¤');
    } catch (error) {
        console.error('æ¸…é™¤éŠæˆ²é€²åº¦å¤±æ•—:', error);
    }
}

// ===================
// å•†åº—åŠŸèƒ½
// ===================

// æ›´æ–°å•†åº—é¡¯ç¤º
function updateShopDisplay() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç©å®¶ç‹€æ…‹é¡¯ç¤º
    document.getElementById('player-points').textContent = PLAYER_DATA.points;
    document.getElementById('player-health').textContent = `${PLAYER_DATA.health}/${PLAYER_DATA.maxHealth}`;
    document.getElementById('player-defense').textContent = `${PLAYER_DATA.defense}/${PLAYER_DATA.maxDefense}`;
    document.getElementById('player-attack').textContent = `${PLAYER_DATA.attack}/${PLAYER_DATA.maxAttack}`;
    document.getElementById('player-free-unlocks').textContent = PLAYER_DATA.freeUnlocks;
    
    // æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
    updateUnlockableCount();
    
    // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    updateShopButtons();
}

// æ›´æ–°å¯è§£é–å–®å­—æ•¸é‡
function updateUnlockableCount() {
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    document.getElementById('unlockable-count').textContent = unlockableWords.length;
}

// æ›´æ–°å•†åº—æŒ‰éˆ•ç‹€æ…‹
function updateShopButtons() {
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');
    const unlockButton = document.querySelector('.unlock-btn');
    const freeUnlockButton = document.querySelector('.free-unlock-btn');
    
    // å‡ç´šæŒ‰éˆ•ç‹€æ…‹
    upgradeButtons.forEach(btn => {
        const isAffordable = PLAYER_DATA.points >= SHOP_PRICES.upgrade;
        btn.disabled = !isAffordable;
    });
    
    // æª¢æŸ¥æ˜¯å¦å·²é”åˆ°ä¸Šé™
    const healthUpgrade = upgradeButtons[0];
    const defenseUpgrade = upgradeButtons[1];
    const attackUpgrade = upgradeButtons[2];
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        healthUpgrade.disabled = true;
        healthUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        healthUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        defenseUpgrade.disabled = true;
        defenseUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        defenseUpgrade.textContent = '10é»';
    }
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        attackUpgrade.disabled = true;
        attackUpgrade.textContent = 'å·²æ»¿ç´š';
    } else {
        attackUpgrade.textContent = '10é»';
    }
    
    // è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canAffordUnlock = PLAYER_DATA.points >= SHOP_PRICES.unlock;
    const hasUnlockableWords = wordsData.filter(word => word.priority === 0).length > 0;
    unlockButton.disabled = !canAffordUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        unlockButton.textContent = 'ç„¡å¯è§£é–';
    } else {
        unlockButton.textContent = '20é»';
    }
    
    // å…è²»è§£é–æŒ‰éˆ•ç‹€æ…‹
    const canFreeUnlock = PLAYER_DATA.freeUnlocks > 0;
    freeUnlockButton.disabled = !canFreeUnlock || !hasUnlockableWords;
    
    if (!hasUnlockableWords) {
        freeUnlockButton.textContent = 'ç„¡å¯è§£é–';
    } else if (!canFreeUnlock) {
        freeUnlockButton.textContent = 'ç„¡å…è²»æ¬¡æ•¸';
    } else {
        freeUnlockButton.textContent = 'å…è²»è§£é–';
    }
}

// é¡¯ç¤ºå•†åº—è¨Šæ¯
function showShopMessage(message, type = 'info') {
    const messageElement = document.getElementById('shop-message');
    messageElement.textContent = message;
    messageElement.className = `shop-message ${type}`;
    
    // 3ç§’å¾Œæ¸…é™¤è¨Šæ¯
    setTimeout(() => {
        messageElement.textContent = '';
        messageElement.className = 'shop-message';
    }, 3000);
}

// é‚„åŸéŠæˆ²
function resetGame() {
    if (confirm('ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿé€™å°‡æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼')) {
        // æ¸…é™¤å„²å­˜çš„é€²åº¦
        clearGameProgress();
        
        // é‡æ–°è¼‰å…¥åŸå§‹è³‡æ–™ä¸¦é‡ç½®æ‰€æœ‰å–®å­—çš„priorityç‚º0
        wordsData = WORDS_DATA.map(word => ({
            ...word,
            priority: 0  // ç¢ºä¿æ‰€æœ‰å–®å­—çš„priorityéƒ½é‡ç½®ç‚º0
        }));
        
        // é‡ç½®ç©å®¶è³‡æ–™
        Object.assign(PLAYER_DATA, INITIAL_PLAYER_DATA);
        
        // éš¨æ©Ÿé¸å–20å€‹å–®å­—è¨­ç‚ºpriority 1
        const availableWords = [...wordsData];
        shuffleArray(availableWords);
        for (let i = 0; i < Math.min(20, availableWords.length); i++) {
            availableWords[i].priority = 1;
        }
        
        // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
        setupReviewMode();
        updateMainPageStatus();
        
        // å„²å­˜é‡ç½®å¾Œçš„åˆå§‹ç‹€æ…‹
        saveGameProgress();
        
        // æ›´æ–°å•†åº—é¡¯ç¤º
        updateShopDisplay();
        
        showShopMessage('éŠæˆ²å·²é‡ç½®ï¼éš¨æ©Ÿé¸å–äº†20å€‹å–®å­—é–‹å§‹æ–°éŠæˆ²ï¼Œä¸¦ç²å¾—1æ¬¡å…è²»è§£é–æ©Ÿæœƒ', 'success');
        
        console.log('éŠæˆ²å·²é‡ç½®');
    }
}

// å‡ç´šç”Ÿå‘½å€¼
function upgradeHealth() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.health >= PLAYER_DATA.maxHealth) {
        showShopMessage('ç”Ÿå‘½å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.health += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('ç”Ÿå‘½å€¼å‡ç´šæˆåŠŸï¼+1 ç”Ÿå‘½å€¼', 'success');
}

// å‡ç´šé˜²ç¦¦å€¼
function upgradeDefense() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.defense >= PLAYER_DATA.maxDefense) {
        showShopMessage('é˜²ç¦¦å€¼å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.defense += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('é˜²ç¦¦å€¼å‡ç´šæˆåŠŸï¼+1 é˜²ç¦¦å€¼', 'success');
}

// å‡ç´šæ”»æ“ŠåŠ›
function upgradeAttack() {
    if (PLAYER_DATA.points < SHOP_PRICES.upgrade) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•å‡ç´š', 'error');
        return;
    }
    
    if (PLAYER_DATA.attack >= PLAYER_DATA.maxAttack) {
        showShopMessage('æ”»æ“ŠåŠ›å·²é”åˆ°ä¸Šé™', 'error');
        return;
    }
    
    PLAYER_DATA.points -= SHOP_PRICES.upgrade;
    PLAYER_DATA.attack += 1;
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    showShopMessage('æ”»æ“ŠåŠ›å‡ç´šæˆåŠŸï¼+1 æ”»æ“ŠåŠ›', 'success');
}

// è§£é–å–®å­—ï¼ˆä¸€æ¬¡è§£é–10å€‹ï¼‰
function unlockWord() {
    if (PLAYER_DATA.points < SHOP_PRICES.unlock) {
        showShopMessage('é»æ•¸ä¸è¶³ç„¡æ³•è§£é–', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.points -= SHOP_PRICES.unlock;
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`æˆåŠŸè§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`æˆåŠŸè§£é– ${unlockCount} å€‹å–®å­—ï¼åŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// å…è²»è§£é–å–®å­—
function freeUnlockWord() {
    if (PLAYER_DATA.freeUnlocks <= 0) {
        showShopMessage('æ²’æœ‰å…è²»è§£é–æ¬¡æ•¸', 'error');
        return;
    }
    
    // æ‰¾åˆ°æ‰€æœ‰priorityç‚º0çš„å–®å­—
    const unlockableWords = wordsData.filter(word => word.priority === 0);
    
    if (unlockableWords.length === 0) {
        showShopMessage('æ²’æœ‰å¯è§£é–çš„å–®å­—', 'error');
        return;
    }
    
    // æ±ºå®šè¦è§£é–çš„å–®å­—æ•¸é‡ï¼ˆæœ€å¤š10å€‹ï¼Œä½†ä¸è¶…éå¯è§£é–çš„ç¸½æ•¸ï¼‰
    const unlockCount = Math.min(10, unlockableWords.length);
    
    // éš¨æ©Ÿé¸æ“‡è¦è§£é–çš„å–®å­—
    shuffleArray(unlockableWords);
    const wordsToUnlock = unlockableWords.slice(0, unlockCount);
    
    PLAYER_DATA.freeUnlocks -= 1; // æ¶ˆè€—ä¸€æ¬¡å…è²»è§£é–
    
    // è§£é–é¸ä¸­çš„å–®å­—
    wordsToUnlock.forEach(word => {
        word.priority = 1;
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼ä»¥åŒ…å«æ–°è§£é–çš„å–®å­—
    setupReviewMode();
    updateMainPageStatus();
    
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    
    // é¡¯ç¤ºè§£é–è¨Šæ¯
    if (unlockCount === 1) {
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–å–®å­—ï¼š${wordsToUnlock[0].word} (${wordsToUnlock[0].meaning})`, 'success');
    } else {
        const firstWord = wordsToUnlock[0];
        showShopMessage(`å…è²»è§£é–æˆåŠŸï¼è§£é–äº† ${unlockCount} å€‹å–®å­—ï¼ŒåŒ…å«ï¼š${firstWord.word} (${firstWord.meaning}) ç­‰`, 'success');
    }
}

// çµ¦ç©å®¶æ·»åŠ é»æ•¸çš„å‡½æ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦æˆ–çå‹µæ©Ÿåˆ¶ï¼‰
function addPoints(amount) {
    PLAYER_DATA.points += amount;
    saveGameProgress(); // è‡ªå‹•ä¿å­˜é€²åº¦
    updateShopDisplay();
    console.log(`ç²å¾— ${amount} é»æ•¸ï¼ç•¶å‰é»æ•¸ï¼š${PLAYER_DATA.points}`);
}

// æ¸¬è©¦ç”¨ï¼šæ·»åŠ ä¸€äº›é»æ•¸
// ä½ å¯ä»¥åœ¨ç€è¦½å™¨æ§åˆ¶å°ä¸­åŸ·è¡Œ addPoints(50) ä¾†æ¸¬è©¦å•†åº—åŠŸèƒ½
console.log('å•†åº—åŠŸèƒ½å·²è¼‰å…¥ï¼ä½¿ç”¨ addPoints(æ•¸é‡) ä¾†æ·»åŠ æ¸¬è©¦é»æ•¸');

// èª¿è©¦åŠŸèƒ½ï¼šæŸ¥çœ‹ç•¶å‰éŠæˆ²ç‹€æ…‹
function debugGameState() {
    console.log('=== éŠæˆ²ç‹€æ…‹ ===');
    console.log('ç©å®¶è³‡æ–™:', PLAYER_DATA);
    console.log('å¯è¤‡ç¿’å–®å­—æ•¸é‡:', reviewWords.length);
    console.log('å¯è§£é–å–®å­—æ•¸é‡:', wordsData.filter(w => w.priority === 0).length);
    console.log('ç¸½å–®å­—æ•¸é‡:', wordsData.length);
    
    // æª¢æŸ¥priorityåˆ†ä½ˆ
    const priorityDistribution = {};
    wordsData.forEach(word => {
        priorityDistribution[word.priority] = (priorityDistribution[word.priority] || 0) + 1;
    });
    console.log('Priorityåˆ†ä½ˆ:', priorityDistribution);
}

// èª¿è©¦åŠŸèƒ½ï¼šæ¸…é™¤å„²å­˜çš„é€²åº¦
function debugClearProgress() {
    clearGameProgress();
    console.log('å·²æ¸…é™¤å„²å­˜çš„é€²åº¦ï¼Œé‡æ–°è¼‰å…¥é é¢ä»¥é‡ç½®éŠæˆ²');
}

console.log('èª¿è©¦åŠŸèƒ½å·²è¼‰å…¥ï¼šdebugGameState() å’Œ debugClearProgress()');

// ===================
// Bossæˆ°é¬¥åŠŸèƒ½
// ===================

// Bossæˆ°é¬¥ç‹€æ…‹è®Šæ•¸
let bossGameState = {
    isActive: false,
    round: 0,
    maxRounds: 20,
    score: 0,
    currentHealth: 0,
    timeRemaining: 0,
    timer: null,
    currentQuestion: null,
    questionQueue: [],
    correctAnswer: -1,
    isAnswered: false,
    wordPriorityUpdates: new Map() // è¨˜éŒ„å–®å­—å„ªå…ˆåº¦çš„æ›´æ–°
};

// æ¸¬é©—æ¨¡å¼æšèˆ‰
const QUIZ_MODES = {
    SENTENCE_TO_MEANING: 1,    // çµ¦ä¾‹å¥é¸æ„æ€
    MEANING_TO_SENTENCE: 2,    // çµ¦æ„æ€é¸ä¾‹å¥
    FILL_IN_BLANK: 3          // å¡«ç©ºé¡Œ
};

// å„ªå…ˆéšŠåˆ—é¡
class PriorityQueue {
    constructor() {
        this.items = [];
    }
    
    enqueue(item, priority) {
        const queueElement = { item, priority };
        let added = false;
        
        for (let i = 0; i < this.items.length; i++) {
            if (queueElement.priority < this.items[i].priority) {
                this.items.splice(i, 0, queueElement);
                added = true;
                break;
            }
        }
        
        if (!added) {
            this.items.push(queueElement);
        }
    }
    
    dequeue() {
        return this.items.shift();
    }
    
    isEmpty() {
        return this.items.length === 0;
    }
    
    size() {
        return this.items.length;
    }
}

// åˆå§‹åŒ–Bossæˆ°é¬¥é é¢
function initializeBossPage() {
    if (typeof PLAYER_DATA === 'undefined') {
        console.error('PLAYER_DATA æœªè¼‰å…¥');
        return;
    }
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
    
    // é¡¯ç¤ºé–‹å§‹ç•«é¢
    showBossStartScreen();
}

// é¡¯ç¤ºBossæˆ°é¬¥é–‹å§‹ç•«é¢
function showBossStartScreen() {
    document.getElementById('boss-start-screen').style.display = 'block';
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é‡ç½®æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = false;
    bossGameState.round = 0;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.wordPriorityUpdates.clear();
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    updateBossStatusDisplay();
}

// é–‹å§‹Bossæˆ°é¬¥
function startBossBattle() {
    if (reviewWords.length === 0) {
        alert('æ²’æœ‰å¯è¤‡ç¿’çš„å–®å­—ï¼Œè«‹å…ˆå‰å¾€å•†åº—è§£é–æ–°å–®å­—ï¼');
        return;
    }
    
    // åˆå§‹åŒ–æˆ°é¬¥ç‹€æ…‹
    bossGameState.isActive = true;
    bossGameState.round = 1;
    bossGameState.score = 0;
    bossGameState.currentHealth = PLAYER_DATA.health;
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.wordPriorityUpdates.clear();
    
    // ç¦ç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = true;
    
    // å»ºç«‹å„ªå…ˆéšŠåˆ—
    buildQuestionQueue();
    
    // åˆ‡æ›åˆ°éŠæˆ²ç•«é¢
    document.getElementById('boss-start-screen').style.display = 'none';
    document.getElementById('boss-game-screen').style.display = 'block';
    document.getElementById('boss-end-screen').style.display = 'none';
    
    // é–‹å§‹ç¬¬ä¸€å›åˆ
    startNextRound();
}

// å»ºç«‹é¡Œç›®éšŠåˆ—
function buildQuestionQueue() {
    const priorityQueue = new PriorityQueue();
    
    // å°‡å¯è¤‡ç¿’çš„å–®å­—æŒ‰å„ªå…ˆåº¦æ’å…¥éšŠåˆ—
    reviewWords.forEach(word => {
        priorityQueue.enqueue(word, word.priority);
    });
    
    // å¾å„ªå…ˆéšŠåˆ—ä¸­å–å‡ºå–®å­—ï¼ŒåŒå„ªå…ˆåº¦å…§éš¨æ©Ÿæ’åº
    bossGameState.questionQueue = [];
    const priorityGroups = {};
    
    // æŒ‰å„ªå…ˆåº¦åˆ†çµ„
    while (!priorityQueue.isEmpty()) {
        const item = priorityQueue.dequeue();
        const priority = item.priority;
        if (!priorityGroups[priority]) {
            priorityGroups[priority] = [];
        }
        priorityGroups[priority].push(item.item);
    }
    
    // æ¯çµ„å…§éš¨æ©Ÿæ’åºå¾ŒåŠ å…¥éšŠåˆ—
    const sortedPriorities = Object.keys(priorityGroups).map(Number).sort((a, b) => a - b);
    sortedPriorities.forEach(priority => {
        const group = priorityGroups[priority];
        shuffleArray(group);
        bossGameState.questionQueue.push(...group);
    });
    
    console.log('Bossæˆ°é¬¥é¡Œç›®éšŠåˆ—å·²å»ºç«‹:', bossGameState.questionQueue.length, 'å€‹é¡Œç›®');
}

// é–‹å§‹ä¸‹ä¸€å›åˆ
function startNextRound() {
    if (bossGameState.round > bossGameState.maxRounds) {
        endBossBattle(true); // å‹åˆ©
        return;
    }
    
    if (bossGameState.currentHealth <= 0) {
        endBossBattle(false); // å¤±æ•—
        return;
    }
    
    // ç”Ÿæˆé¡Œç›®
    generateQuestion();
    
    // é‡ç½®è¨ˆæ™‚å™¨
    bossGameState.timeRemaining = PLAYER_DATA.attack;
    bossGameState.isAnswered = false;
    
    // é–‹å§‹å€’æ•¸è¨ˆæ™‚
    startTimer();
    
    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    updateBossStatusDisplay();
}

// ç”Ÿæˆé¡Œç›®
function generateQuestion() {
    if (bossGameState.questionQueue.length === 0) {
        console.error('é¡Œç›®éšŠåˆ—ç‚ºç©º');
        return;
    }
    
    // å¾éšŠåˆ—ä¸­å–å¾—ç•¶å‰é¡Œç›®ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
    const questionIndex = (bossGameState.round - 1) % bossGameState.questionQueue.length;
    const currentWord = bossGameState.questionQueue[questionIndex];
    bossGameState.currentQuestion = currentWord;
    
    // éš¨æ©Ÿé¸æ“‡æ¸¬é©—æ¨¡å¼
    const modes = Object.values(QUIZ_MODES);
    const selectedMode = modes[Math.floor(Math.random() * modes.length)];
    
    // æ ¹æ“šæ¨¡å¼ç”Ÿæˆé¡Œç›®
    switch (selectedMode) {
        case QUIZ_MODES.SENTENCE_TO_MEANING:
            generateSentenceToMeaningQuestion(currentWord);
            break;
        case QUIZ_MODES.MEANING_TO_SENTENCE:
            generateMeaningToSentenceQuestion(currentWord);
            break;
        case QUIZ_MODES.FILL_IN_BLANK:
            generateFillInBlankQuestion(currentWord);
            break;
    }
}

// ç”Ÿæˆã€Œçµ¦ä¾‹å¥é¸æ„æ€ã€é¡Œç›®
function generateSentenceToMeaningQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šä¾‹å¥é¸æ„æ€';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡ä¾‹å¥çš„æ­£ç¢ºä¸­æ–‡æ„æ€ï¼š';
    
    // é¡¯ç¤ºä¾‹å¥ï¼ˆç§»é™¤<>ç¬¦è™Ÿï¼‰
    const sentence = word.sentence.replace(/<[^>]*>/g, '');
    document.getElementById('question-text').textContent = sentence;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯æ„æ€ï¼‰
    const options = generateOptions(word, 'meaning');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œçµ¦æ„æ€é¸ä¾‹å¥ã€é¡Œç›®
function generateMeaningToSentenceQuestion(word) {
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šæ„æ€é¸ä¾‹å¥';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„ä¾‹å¥ï¼š';
    
    // é¡¯ç¤ºæ„æ€
    document.getElementById('question-text').textContent = word.meaning;
    
    // ç”Ÿæˆé¸é …ï¼ˆæ­£ç¢ºç­”æ¡ˆæ˜¯ä¾‹å¥ï¼‰
    const options = generateOptions(word, 'sentence');
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆã€Œå¡«ç©ºé¡Œã€
function generateFillInBlankQuestion(word) {
    if (!word.sentence.includes('<') || !word.sentence.includes('>')) {
        // å¦‚æœæ²’æœ‰<>æ¨™è¨˜ï¼Œé™ç´šç‚ºä¾‹å¥é¸æ„æ€
        generateSentenceToMeaningQuestion(word);
        return;
    }
    
    document.getElementById('question-type').textContent = 'é¡Œå‹ï¼šå¡«ç©ºé¡Œ';
    document.getElementById('question-title').textContent = 'è«‹é¸æ“‡æ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ï¼š';
    
    // å°‡<å–®å­—>æ›¿æ›ç‚ºç©ºæ ¼
    const sentenceWithBlanks = word.sentence.replace(/<[^>]*>/g, '______');
    document.getElementById('question-text').textContent = sentenceWithBlanks;
    
    // æ­£ç¢ºç­”æ¡ˆæ˜¯è¢«<>åŒ…åœçš„å–®å­—ï¼ˆå»é™¤<>ç¬¦è™Ÿï¼‰
    const correctWord = word.sentence.match(/<([^>]+)>/)[1];
    
    // ç”Ÿæˆé¸é …ï¼ˆåŒ…å«æ­£ç¢ºå–®å­—å’Œå…¶ä»–éš¨æ©Ÿå–®å­—ï¼‰
    const options = generateFillInBlankOptions(correctWord);
    displayAnswerOptions(options.options, options.correctIndex);
}

// ç”Ÿæˆé¸é …
function generateOptions(correctWord, type) {
    const options = [];
    let correctValue;
    
    // å–å¾—æ­£ç¢ºç­”æ¡ˆ
    if (type === 'meaning') {
        correctValue = correctWord.meaning;
    } else if (type === 'sentence') {
        correctValue = correctWord.sentence.replace(/<[^>]*>/g, '');
    }
    
    // éš¨æ©Ÿæ”¾ç½®æ­£ç¢ºç­”æ¡ˆ
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …
    const wrongOptions = [];
    const allWords = [...wordsData]; // åŒ…å«æ‰€æœ‰å–®å­—ï¼ˆåŒ…æ‹¬æœªè§£é–çš„ï¼‰
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (word.word_id !== correctWord.word_id && wrongOptions.length < 3) {
            let wrongValue;
            if (type === 'meaning') {
                wrongValue = word.meaning;
            } else if (type === 'sentence') {
                wrongValue = word.sentence.replace(/<[^>]*>/g, '');
            }
            
            // é¿å…é‡è¤‡å’Œç›¸åŒç­”æ¡ˆ
            if (wrongValue !== correctValue && !wrongOptions.includes(wrongValue)) {
                wrongOptions.push(wrongValue);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctValue);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// ç”Ÿæˆå¡«ç©ºé¡Œé¸é …
function generateFillInBlankOptions(correctWord) {
    const options = [];
    const correctIndex = Math.floor(Math.random() * 4);
    
    // ç”ŸæˆéŒ¯èª¤é¸é …ï¼ˆå…¶ä»–å–®å­—çš„æ‹¼éŸ³ï¼‰
    const wrongOptions = [];
    const allWords = [...wordsData];
    shuffleArray(allWords);
    
    for (const word of allWords) {
        if (wrongOptions.length < 3) {
            // æå–å–®å­—éƒ¨åˆ†ï¼ˆå¯èƒ½åŒ…å«åœ¨ä¾‹å¥ä¸­çš„å–®å­—ï¼‰
            let wordToAdd = word.word;
            if (word.sentence.includes('<') && word.sentence.includes('>')) {
                const match = word.sentence.match(/<([^>]+)>/);
                if (match) {
                    wordToAdd = match[1];
                }
            }
            
            if (wordToAdd !== correctWord && !wrongOptions.includes(wordToAdd)) {
                wrongOptions.push(wordToAdd);
            }
        }
    }
    
    // çµ„åˆé¸é …
    for (let i = 0; i < 4; i++) {
        if (i === correctIndex) {
            options.push(correctWord);
        } else {
            const wrongIndex = Math.min(i < correctIndex ? i : i - 1, wrongOptions.length - 1);
            options.push(wrongOptions[wrongIndex] || 'é¸é …ä¸è¶³');
        }
    }
    
    return { options, correctIndex };
}

// é¡¯ç¤ºç­”æ¡ˆé¸é …
function displayAnswerOptions(options, correctIndex) {
    const answerButtons = document.querySelectorAll('.answer-btn');
    bossGameState.correctAnswer = correctIndex;
    
    answerButtons.forEach((btn, index) => {
        btn.textContent = options[index];
        btn.disabled = false;
        btn.className = 'answer-btn'; // é‡ç½®æ¨£å¼
    });
}

// é–‹å§‹è¨ˆæ™‚å™¨
function startTimer() {
    if (bossGameState.timer) {
        clearInterval(bossGameState.timer);
    }
    
    bossGameState.timer = setInterval(() => {
        bossGameState.timeRemaining--;
        updateBossStatusDisplay();
        
        if (bossGameState.timeRemaining <= 0) {
            clearInterval(bossGameState.timer);
            if (!bossGameState.isAnswered) {
                handleTimeOut();
            }
        }
    }, 1000);
}

// è™•ç†è¶…æ™‚ï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¸æ“‡ç­”æ¡ˆï¼ˆæ­¤å‡½æ•¸å·²è¢«ä¸‹æ–¹çš„å¢å¼·ç‰ˆæœ¬æ›¿æ›ï¼‰

// é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
function showCorrectAnswer() {
    const answerButtons = document.querySelectorAll('.answer-btn');
    answerButtons.forEach(btn => btn.disabled = true);
    answerButtons[bossGameState.correctAnswer].classList.add('correct');
}

// æ›´æ–°å–®å­—å„ªå…ˆåº¦
function updateWordPriority(word, isCorrect) {
    if (isCorrect) {
        // ç­”å°ï¼špriority += 1
        const newPriority = (bossGameState.wordPriorityUpdates.get(word.word_id) || word.priority) + 1;
        bossGameState.wordPriorityUpdates.set(word.word_id, newPriority);
    } else {
        // ç­”éŒ¯æˆ–è¶…æ™‚ï¼špriority = 1
        bossGameState.wordPriorityUpdates.set(word.word_id, 1);
    }
}

// æ›´æ–°Bossç‹€æ…‹é¡¯ç¤º
function updateBossStatusDisplay() {
    document.getElementById('boss-timer').textContent = bossGameState.timeRemaining;
    document.getElementById('boss-health').textContent = bossGameState.currentHealth;
    document.getElementById('boss-round').textContent = `${bossGameState.round}/${bossGameState.maxRounds}`;
    document.getElementById('boss-score').textContent = bossGameState.score;
}

// çµæŸBossæˆ°é¬¥
function endBossBattle(isVictory) {
    bossGameState.isActive = false;
    clearInterval(bossGameState.timer);
    
    // æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
    applyWordPriorityUpdates();
    
    // åˆ‡æ›åˆ°çµæŸç•«é¢
    document.getElementById('boss-game-screen').style.display = 'none';
    document.getElementById('boss-end-screen').style.display = 'block';
    
    // å•Ÿç”¨è¿”å›æŒ‰éˆ•
    document.getElementById('boss-back-btn').disabled = false;
    
    // é¡¯ç¤ºçµæœ
    showBattleResult(isVictory);
}

// é¡¯ç¤ºæˆ°é¬¥çµæœ
function showBattleResult(isVictory) {
    const endResult = document.getElementById('end-result');
    
    if (isVictory) {
        // å‹åˆ©
        PLAYER_DATA.points += bossGameState.score;
        saveGameProgress();
        
        endResult.innerHTML = `
            <div class="victory-screen">
                <h2>ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼ ğŸ‰</h2>
                <div class="victory-message">
                    <p>ğŸ† æ­å–œæ‚¨æˆ°å‹äº†Bossï¼</p>
                    <p>âš”ï¸ å®Œæˆäº† ${bossGameState.maxRounds} å›åˆçš„æ¿€çƒˆæˆ°é¬¥</p>
                    <p>â¤ï¸ å‰©é¤˜ç”Ÿå‘½å€¼ï¼š${bossGameState.currentHealth}</p>
                </div>
                <div class="final-score">
                    ğŸ’° ç²å¾—é»æ•¸ï¼š${bossGameState.score}
                </div>
                <p>ğŸ é»æ•¸å·²è‡ªå‹•åŠ å…¥æ‚¨çš„å¸³æˆ¶</p>
            </div>
        `;
        
        // æ›´æ–°å•†åº—é¡¯ç¤ºï¼ˆå¦‚æœåœ¨å•†åº—é é¢ï¼‰
        updateShopDisplay();
        
    } else {
        // å¤±æ•—
        endResult.innerHTML = `
            <div class="defeat-screen">
                <h2>ğŸ’€ æŒ‘æˆ°å¤±æ•— ğŸ’€</h2>
                <div class="defeat-message">
                    <p>ğŸ˜µ æ‚¨çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†...</p>
                    <p>âš”ï¸ åœ¨ç¬¬ ${bossGameState.round} å›åˆå€’ä¸‹</p>
                    <p>ğŸ’” Bosså¤ªå¼·å¤§äº†ï¼Œéœ€è¦æ›´å¤šç·´ç¿’</p>
                </div>
                <div class="final-score">
                    ğŸ’¸ å¾—åˆ†æ­¸é›¶ï¼š0
                </div>
                <p>ğŸ’ª åŠ æ²¹ï¼æå‡å¯¦åŠ›å†ä¾†æŒ‘æˆ°å§ï¼</p>
            </div>
        `;
    }
}

// æ‡‰ç”¨å–®å­—å„ªå…ˆåº¦æ›´æ–°
function applyWordPriorityUpdates() {
    bossGameState.wordPriorityUpdates.forEach((newPriority, wordId) => {
        // ä½¿ç”¨ word_id æ‰¾åˆ°å°æ‡‰çš„å–®å­—ä¸¦æ›´æ–°å„ªå…ˆåº¦
        for (let word of wordsData) {
            if (word.word_id === wordId) {
                const oldPriority = word.priority;
                word.priority = newPriority;
                console.log(`æ›´æ–°å–®å­— ${word.word} (ID: ${wordId}, ${word.spelling}) å„ªå…ˆåº¦: ${oldPriority} â†’ ${newPriority}`);
                break; // æ‰¾åˆ°å”¯ä¸€åŒ¹é…å¾Œç«‹å³ä¸­æ–·ï¼Œé¿å…ç¹¼çºŒæœå°‹
            }
        }
    });
    
    // é‡æ–°è¨­å®šè¤‡ç¿’æ¨¡å¼
    setupReviewMode();
    updateMainPageStatus();
    
    // å„²å­˜éŠæˆ²é€²åº¦
    saveGameProgress();
    
    console.log(`Bossæˆ°é¬¥çµæŸï¼Œå…±æ›´æ–°äº† ${bossGameState.wordPriorityUpdates.size} å€‹å–®å­—çš„å„ªå…ˆåº¦`);
}

// è¿”å›ä¸»é é¢ï¼ˆå¸¶æœ‰æˆ°é¬¥ç‹€æ…‹æª¢æŸ¥ï¼‰
function returnToMain() {
    if (bossGameState.isActive) {
        if (confirm('æˆ°é¬¥é€²è¡Œä¸­ï¼Œç¢ºå®šè¦è¿”å›ä¸»é é¢å—ï¼Ÿé€™å°‡çµæŸç•¶å‰æˆ°é¬¥ã€‚')) {
            bossGameState.isActive = false;
            clearInterval(bossGameState.timer);
            showPage('main-page');
        }
    } else {
        showPage('main-page');
    }
}

// ä¿®æ”¹åŸæœ‰çš„showPageå‡½æ•¸ä»¥æ”¯æ´Bossé é¢åˆå§‹åŒ–
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage(pageId);
    
    if (pageId === 'boss-page') {
        initializeBossPage();
    }
};

// ===================
// Bossæˆ°é¬¥ç‰¹æ•ˆåŠŸèƒ½
// ===================

// é¡¯ç¤ºå‚·å®³ç‰¹æ•ˆï¼ˆç«æŸ±å’Œæµè¡€ï¼‰ - åŸå§‹ç‰ˆæœ¬ï¼Œå°‡è¢«å¢å¼·ç‰ˆæœ¬æ›¿æ›

// é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆï¼ˆé‡‘å¹£å’Œå¾—åˆ†é¡¯ç¤ºï¼‰
function showScoreEffect(score) {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºé‡‘å¹£ç‰¹æ•ˆ
    const coinEffect = document.createElement('div');
    coinEffect.className = 'coin-effect';
    coinEffect.textContent = 'ğŸ’°';
    effectsContainer.appendChild(coinEffect);
    
    // å‰µå»ºå¾—åˆ†é¡¯ç¤ºç‰¹æ•ˆ
    const scorePopup = document.createElement('div');
    scorePopup.className = 'score-popup';
    scorePopup.textContent = `+${score} åˆ†`;
    effectsContainer.appendChild(scorePopup);
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (coinEffect.parentNode) {
            effectsContainer.removeChild(coinEffect);
        }
        if (scorePopup.parentNode) {
            effectsContainer.removeChild(scorePopup);
        }
    }, 500);
}

// æ’­æ”¾æˆåŠŸéŸ³æ•ˆï¼ˆé‡‘å¹£è²éŸ³ï¼‰
function playSuccessSound() {
    try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºé‡‘å¹£éŸ³æ•ˆ
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºéŸ³é »åºåˆ—
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const noteDuration = 0.1; // æ¯å€‹éŸ³ç¬¦0.1ç§’
            
            notes.forEach((frequency, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + noteDuration);
                
                const startTime = audioContext.currentTime + (index * noteDuration);
                oscillator.start(startTime);
                oscillator.stop(startTime + noteDuration);
            });
        } else {
            // é™ç´šï¼šä½¿ç”¨é »ç‡ç”Ÿæˆå™¨æ¨¡æ“¬éŸ³æ•ˆ
            console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š é‡‘å¹£éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆï¼ˆä½æ²‰çš„å—¡å—¡è²ï¼‰
function playErrorSound() {
    try {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å‰µå»ºä½æ²‰çš„éŒ¯èª¤éŸ³æ•ˆ
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime); // ä½é »
            oscillator.type = 'sawtooth'; // é‹¸é½’æ³¢å½¢ï¼Œè½èµ·ä¾†æ›´ç²—ç³™
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } else {
            console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆç€è¦½å™¨ä¸æ”¯æ´Web Audio APIï¼‰');
        }
    } catch (error) {
        console.log('ğŸ”Š éŒ¯èª¤éŸ³æ•ˆæ’­æ”¾ï¼ˆéŸ³æ•ˆç”Ÿæˆå¤±æ•—ï¼‰');
    }
}

// å¢å¼·ç‰ˆå‚·å®³ç‰¹æ•ˆï¼ˆåŒ…å«éŸ³æ•ˆï¼‰
function showDamageEffect() {
    const effectsContainer = document.getElementById('boss-effects');
    
    // å‰µå»ºç«æŸ±ç‰¹æ•ˆ
    const fireEffect = document.createElement('div');
    fireEffect.className = 'fire-effect';
    effectsContainer.appendChild(fireEffect);
    
    // å‰µå»ºæµè¡€ç‰¹æ•ˆ
    const bloodEffect = document.createElement('div');
    bloodEffect.className = 'blood-effect';
    effectsContainer.appendChild(bloodEffect);
    
    // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
    playErrorSound();
    
    // 0.5ç§’å¾Œç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        if (fireEffect.parentNode) {
            effectsContainer.removeChild(fireEffect);
        }
        if (bloodEffect.parentNode) {
            effectsContainer.removeChild(bloodEffect);
        }
    }, 500);
}

// å‰µå»ºæµ®å‹•å‚·å®³æ•¸å­—ç‰¹æ•ˆ
function showFloatingDamage(damage) {
    const effectsContainer = document.getElementById('boss-effects');
    
    const damageText = document.createElement('div');
    damageText.className = 'floating-damage';
    damageText.textContent = `-${damage}`;
    damageText.style.cssText = `
        position: absolute;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e53e3e;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        animation: floatUp 1s ease-out forwards;
        pointer-events: none;
        z-index: 10000;
    `;
    
    // æ·»åŠ CSSå‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
        @keyframes floatUp {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -80%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -120%) scale(1);
                opacity: 0;
            }
        }
    `;
    
    if (!document.head.querySelector('style[data-floating-damage]')) {
        style.setAttribute('data-floating-damage', 'true');
        document.head.appendChild(style);
    }
    
    effectsContainer.appendChild(damageText);
    
    // 1ç§’å¾Œç§»é™¤
    setTimeout(() => {
        if (damageText.parentNode) {
            effectsContainer.removeChild(damageText);
        }
    }, 1000);
}

// ä¿®æ”¹å¾Œçš„handleTimeOutå‡½æ•¸ï¼ˆæ›¿æ›åŸæœ¬çš„ç‰ˆæœ¬ï¼‰
function handleTimeOut() {
    bossGameState.isAnswered = true;
    
    // æ‰£ç”Ÿå‘½å€¼
    bossGameState.currentHealth -= 2;
    
    // æ›´æ–°å–®å­—å„ªå…ˆåº¦
    updateWordPriority(bossGameState.currentQuestion, false);
    
    // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
    showCorrectAnswer();
    
    // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
    showDamageEffect();
    showFloatingDamage(2);
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

// é‡æ–°å®šç¾©selectAnswerä»¥åŒ…å«ç‰¹æ•ˆ
function selectAnswer(answerIndex) {
    if (bossGameState.isAnswered || !bossGameState.isActive) {
        return;
    }
    
    bossGameState.isAnswered = true;
    clearInterval(bossGameState.timer);
    
    const answerButtons = document.querySelectorAll('.answer-btn');
    const isCorrect = answerIndex === bossGameState.correctAnswer;
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•
    answerButtons.forEach(btn => btn.disabled = true);
    
    if (isCorrect) {
        // ç­”å°
        answerButtons[answerIndex].classList.add('correct');
        
        // è¨ˆç®—å¾—åˆ†
        const score = Math.max(0, Math.floor(bossGameState.timeRemaining + PLAYER_DATA.defense - 13));
        bossGameState.score += score;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, true);
        
        // é¡¯ç¤ºå¾—åˆ†ç‰¹æ•ˆ
        showScoreEffect(score);
        
    } else {
        // ç­”éŒ¯
        answerButtons[answerIndex].classList.add('wrong');
        answerButtons[bossGameState.correctAnswer].classList.add('correct');
        
        // æ‰£ç”Ÿå‘½å€¼
        bossGameState.currentHealth -= 2;
        
        // æ›´æ–°å–®å­—å„ªå…ˆåº¦
        updateWordPriority(bossGameState.currentQuestion, false);
        
        // æ’­æ”¾éŒ¯èª¤ç‰¹æ•ˆå’Œæµ®å‹•å‚·å®³
        showDamageEffect();
        showFloatingDamage(2);
    }
    
    updateBossStatusDisplay();
    
    // å»¶é²é€²å…¥ä¸‹ä¸€å›åˆ
    setTimeout(() => {
        bossGameState.round++;
        startNextRound();
    }, 1500);
}

```

ç¾åœ¨è®“æˆ‘åˆªé™¤è‡¨æ™‚è…³æœ¬ä¸¦æ›´æ–°ä»»å‹™ç‹€æ…‹ï¼š

ç¾åœ¨è®“æˆ‘æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•èªæ³•éŒ¯èª¤ï¼š

å®Œç¾ï¼ç¾åœ¨è®“æˆ‘æ¸¬è©¦ä¸€ä¸‹ä¿®æ”¹å¾Œçš„ç³»çµ±ï¼š

## ğŸ‰ å•é¡Œä¿®å¾©å®Œæˆï¼

æˆ‘å·²ç¶“æˆåŠŸå¯¦ç¾äº†æ‚¨å»ºè­°çš„ `word_id` ç³»çµ±ä¾†è§£æ±ºå–®å­—å„ªå…ˆåº¦æ›´æ–°çš„å•é¡Œï¼š

### âœ… ä¿®æ”¹å…§å®¹

1. **ç‚ºæ¯å€‹å–®å­—æ·»åŠ å”¯ä¸€çš„ `word_id`**ï¼š
   - ä½¿ç”¨ Python è…³æœ¬ç‚º `words_data.js` ä¸­çš„ 578 å€‹å–®å­—æ·»åŠ äº†å¾ 1 é–‹å§‹çš„å”¯ä¸€ ID
   - æ¯å€‹å–®å­—ç¾åœ¨éƒ½æœ‰ `word_id` å±¬æ€§

2. **ä¿®æ”¹å„ªå…ˆåº¦æ›´æ–°é‚è¼¯**ï¼š
   - `updateWordPriority()` å‡½æ•¸ç¾åœ¨ä½¿ç”¨ `word.word_id` è€Œä¸æ˜¯ `word.spelling` 
   - `applyWordPriorityUpdates()` å‡½æ•¸ä½¿ç”¨ `word_id` ç²¾ç¢ºå®šä½å–®å­—ï¼Œé¿å…å½±éŸ¿å…¶ä»–ç›¸åŒæ‹¼éŸ³çš„å–®å­—
   - æ·»åŠ äº† `break` èªå¥ç¢ºä¿æ‰¾åˆ°åŒ¹é…å¾Œç«‹å³åœæ­¢æœå°‹

3. **æ”¹å–„é¸é …ç”Ÿæˆé‚è¼¯**ï¼š
   - `generateOptions()` å‡½æ•¸ä½¿ç”¨ `word_id` æ¯”è¼ƒï¼Œé¿å…å°‡åŒä¸€å–®å­—ä½œç‚ºéŒ¯èª¤é¸é …
   - å„ªåŒ–äº† `generateFillInBlankOptions()` å‡½æ•¸

4. **å¢å¼·èª¿è©¦ä¿¡æ¯**ï¼š
   - æ›´æ–°æ—¥èªŒç¾åœ¨é¡¯ç¤º `word_id`ã€å–®å­—åç¨±ã€æ‹¼éŸ³å’Œå„ªå…ˆåº¦è®ŠåŒ–
   - é¡¯ç¤ºç¸½å…±æ›´æ–°äº†å¤šå°‘å€‹å–®å­—

### ğŸ”§ é—œéµæ”¹å–„

**ä¹‹å‰çš„å•é¡Œ**ï¼š
```javascript
// éŒ¯èª¤ï¼šå¯èƒ½å½±éŸ¿å¤šå€‹ç›¸åŒ spelling çš„å–®å­—
if (word.spelling === spelling) {
    word.priority = newPriority;
}
```

**ç¾åœ¨çš„è§£æ±ºæ–¹æ¡ˆ**ï¼š
```javascript
// æ­£ç¢ºï¼šåªå½±éŸ¿æŒ‡å®š word_id çš„å–®å­—
if (word.word_id === wordId) {
    word.priority = newPriority;
    break; // æ‰¾åˆ°å¾Œç«‹å³åœæ­¢
}
```

### ğŸ“Š æ¸¬è©¦å»ºè­°

è«‹æ¸¬è©¦ä»¥ä¸‹æƒ…æ³ï¼š
1. é‡ç½®éŠæˆ²ï¼ˆæ‡‰è©²æœ‰ 20 å€‹å¯è¤‡ç¿’å–®å­—ï¼‰
2. é€²è¡Œ Boss æˆ°é¬¥ä¸¦æ•…æ„ç­”éŒ¯ä¸€äº›é¡Œç›®
3. æˆ°é¬¥çµæŸå¾Œæª¢æŸ¥å¯è¤‡ç¿’å–®å­—æ•¸é‡ï¼ˆæ‡‰è©²åªæ›´æ–°å¯¦éš›åƒèˆ‡æ¸¬é©—çš„å–®å­—ï¼‰

ç¾åœ¨ç³»çµ±æœƒç²¾ç¢ºåœ°åªæ›´æ–°å¯¦éš›åƒèˆ‡æˆ°é¬¥æ¸¬é©—çš„å–®å­—ï¼Œä¸æœƒå†å½±éŸ¿åˆ°ä½œç‚ºéŒ¯èª¤é¸é …å‡ºç¾ä½† spelling ç›¸åŒçš„å…¶ä»–å–®å­—äº†ï¼

```javascript
// éŒ¯èª¤ï¼šå¯èƒ½å½±éŸ¿å¤šå€‹ç›¸åŒ spelling çš„å–®å­—
if (word.spelling === spelling) {
    word.priority = newPriority;
}
```

```javascript
// æ­£ç¢ºï¼šåªå½±éŸ¿æŒ‡å®š word_id çš„å–®å­—
if (word.word_id === wordId) {
    word.priority = newPriority;
    break; // æ‰¾åˆ°å¾Œç«‹å³åœæ­¢
}
```

